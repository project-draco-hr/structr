{
  final String type=GraphObject.type.dbName();
  if (node.hasProperty(type)) {
    final Object obj=node.getProperty(type);
    if (obj != null) {
      return StructrApp.getConfiguration().getNodeEntities().get(obj.toString());
    }
  }
 else {
    if (externalNodeTypeName == null) {
      externalNodeTypeName=StructrApp.getConfigurationValue(Services.FOREIGN_TYPE);
    }
    if (externalNodeTypeName != null && node.hasProperty(externalNodeTypeName)) {
      Object typeObj=node.getProperty(externalNodeTypeName);
      if (typeObj != null) {
        String externalNodeType=typeObj.toString();
        return StructrApp.getConfiguration().getNodeEntityClass(typeObj.toString());
      }
    }
  }
  return getGenericNodeType();
}
