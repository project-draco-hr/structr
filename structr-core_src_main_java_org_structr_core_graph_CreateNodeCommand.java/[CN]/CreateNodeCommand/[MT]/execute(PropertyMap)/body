{
  GraphDatabaseService graphDb=(GraphDatabaseService)arguments.get("graphDb");
  Principal user=securityContext.getUser(false);
  T node=null;
  if (graphDb != null) {
    Date now=new Date();
    PropertyMap properties=new PropertyMap(attributes);
    Object typeObject=properties.get(AbstractNode.type);
    Class nodeType=typeObject != null ? SchemaHelper.getEntityClassForRawType(typeObject.toString()) : StructrApp.getConfiguration().getFactoryDefinition().getGenericNodeType();
    NodeFactory<T> nodeFactory=new NodeFactory<>(securityContext);
    boolean isCreation=true;
    node=(T)nodeFactory.instantiateWithType(graphDb.createNode(),nodeType,isCreation);
    if (node != null) {
      TransactionCommand.nodeCreated(node);
      if (nodeType != null) {
        node.unlockReadOnlyPropertiesOnce();
        node.setProperty(GraphObject.type,nodeType.getSimpleName());
      }
      node.unlockReadOnlyPropertiesOnce();
      node.setProperty(GraphObject.id,getNextUuid());
      node.unlockReadOnlyPropertiesOnce();
      node.setProperty(AbstractNode.createdDate,now);
      node.unlockReadOnlyPropertiesOnce();
      node.setProperty(AbstractNode.lastModifiedDate,now);
      if ((user != null) && user instanceof AbstractNode) {
        Principal owner=(Principal)user;
        App app=StructrApp.getInstance(securityContext);
        app.create(owner,(NodeInterface)node,PrincipalOwnsNode.class);
        Security securityRel=app.create(owner,(NodeInterface)node,Security.class);
        securityRel.setAllowed(Permission.values());
        node.unlockReadOnlyPropertiesOnce();
        node.setProperty(AbstractNode.createdBy,user.getProperty(GraphObject.id));
      }
      for (      Entry<PropertyKey,Object> attr : properties.entrySet()) {
        Object value=attr.getValue();
        PropertyKey key=attr.getKey();
        if (key.isReadOnly()) {
          node.unlockReadOnlyPropertiesOnce();
        }
        node.setProperty(key,value);
      }
      properties.clear();
    }
  }
  if (node != null) {
    node.onNodeCreation();
    Set<Transformation<GraphObject>> transformations=StructrApp.getConfiguration().getEntityCreationTransformations(node.getClass());
    for (    Transformation<GraphObject> transformation : transformations) {
      transformation.apply(securityContext,node);
    }
    if (transformations.isEmpty()) {
      logger.log(Level.FINE,"No entity creation transformation for {0}",node.getClass());
    }
  }
  return node;
}
