{
  final DatabaseService graphDb=(DatabaseService)arguments.get("graphDb");
  final Principal user=securityContext.getUser(false);
  T node=null;
  if (graphDb != null) {
    final PropertyMap properties=new PropertyMap(attributes);
    final Object typeObject=properties.get(AbstractNode.type);
    final Class nodeType=typeObject != null ? SchemaHelper.getEntityClassForRawType(typeObject.toString()) : StructrApp.getConfiguration().getFactoryDefinition().getGenericNodeType();
    final NodeFactory<T> nodeFactory=new NodeFactory<>(securityContext);
    final CreationContainer tmp=new CreationContainer();
    final Date now=new Date();
    final boolean isCreation=true;
    String uuid=properties.get(GraphObject.id);
    if (uuid == null) {
      uuid=getNextUuid();
    }
    GraphObject.id.setProperty(securityContext,tmp,uuid);
    GraphObject.type.setProperty(securityContext,tmp,nodeType.getSimpleName());
    AbstractNode.createdDate.setProperty(securityContext,tmp,now);
    if (user != null) {
      AbstractNode.createdBy.setProperty(securityContext,tmp,user.getProperty(GraphObject.id));
    }
    properties.remove(GraphObject.id);
    properties.remove(AbstractNode.type);
    properties.remove(AbstractNode.createdDate);
    properties.remove(AbstractNode.createdBy);
    final Set<String> labels=TypeProperty.getLabelsForType(nodeType);
    final Node dbNode=createNode(graphDb,user,nodeType,labels,tmp.getData());
    node=(T)nodeFactory.instantiateWithType(dbNode,nodeType,null,isCreation);
    if (node != null) {
      TransactionCommand.nodeCreated(user,node);
      for (      final Entry<PropertyKey,Object> attr : properties.entrySet()) {
        node.setProperty(attr.getKey(),attr.getValue());
      }
      properties.clear();
      node.addToIndex();
    }
  }
  if (node != null) {
    node.onNodeCreation();
    Set<Transformation<GraphObject>> transformations=StructrApp.getConfiguration().getEntityCreationTransformations(node.getClass());
    for (    Transformation<GraphObject> transformation : transformations) {
      transformation.apply(securityContext,node);
    }
    if (transformations.isEmpty()) {
      logger.log(Level.FINE,"No entity creation transformation for {0}",node.getClass());
    }
  }
  return node;
}
