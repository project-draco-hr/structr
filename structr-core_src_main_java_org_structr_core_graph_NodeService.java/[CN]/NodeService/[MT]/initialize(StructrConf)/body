{
  final String dbPath=config.getProperty(Services.DATABASE_PATH);
  logger.log(Level.INFO,"Initializing database ({0}) ...",dbPath);
  if (graphDb != null) {
    logger.log(Level.INFO,"Database already running ({0}) ...",dbPath);
    return;
  }
  try {
    graphDb=new GraphDatabaseFactory().newEmbeddedDatabaseBuilder(dbPath).loadPropertiesFromFile(dbPath + "/neo4j.conf").newGraphDatabase();
  }
 catch (  Throwable t) {
    logger.log(Level.INFO,"Database config {0}/neo4j.conf not found",dbPath);
    graphDb=new GraphDatabaseFactory().newEmbeddedDatabaseBuilder(dbPath).newGraphDatabase();
  }
  if (graphDb == null) {
    logger.log(Level.SEVERE,"Database could not be started ({0}) ...",dbPath);
    return;
  }
  filesPath=config.getProperty(Services.FILES_PATH);
  File files=new File(filesPath);
  if (!files.exists()) {
    files.mkdir();
  }
  logger.log(Level.INFO,"Database ready.");
  logger.log(Level.FINE,"Initializing UUID index...");
  try (final Transaction tx=graphDb.beginTx()){
    uuidIndex=graphDb.index().forNodes("uuidAllNodes",LuceneIndexImplementation.EXACT_CONFIG);
    nodeIndices.put(NodeIndex.uuid,uuidIndex);
    logger.log(Level.FINE,"UUID index ready.");
    logger.log(Level.FINE,"Initializing user index...");
    userIndex=graphDb.index().forNodes("nameEmailAllUsers",LuceneIndexImplementation.EXACT_CONFIG);
    nodeIndices.put(NodeIndex.user,userIndex);
    logger.log(Level.FINE,"Node Email index ready.");
    logger.log(Level.FINE,"Initializing exact email index...");
    caseInsensitiveUserIndex=graphDb.index().forNodes("caseInsensitiveAllUsers",MapUtil.stringMap("provider","lucene","type","exact","to_lower_case","true"));
    nodeIndices.put(NodeIndex.caseInsensitiveUser,caseInsensitiveUserIndex);
    logger.log(Level.FINE,"Node case insensitive node index ready.");
    logger.log(Level.FINE,"Initializing case insensitive fulltext node index...");
    fulltextIndex=graphDb.index().forNodes("fulltextAllNodes",LuceneIndexImplementation.FULLTEXT_CONFIG);
    nodeIndices.put(NodeIndex.fulltext,fulltextIndex);
    logger.log(Level.FINE,"Fulltext node index ready.");
    logger.log(Level.FINE,"Initializing keyword node index...");
    keywordIndex=graphDb.index().forNodes("keywordAllNodes",LuceneIndexImplementation.EXACT_CONFIG);
    nodeIndices.put(NodeIndex.keyword,keywordIndex);
    logger.log(Level.FINE,"Keyword node index ready.");
    logger.log(Level.FINE,"Initializing layer index...");
    final Map<String,String> spatialConfig=new HashMap<>();
    spatialConfig.put(LayerNodeIndex.LAT_PROPERTY_KEY,Location.latitude.dbName());
    spatialConfig.put(LayerNodeIndex.LON_PROPERTY_KEY,Location.longitude.dbName());
    spatialConfig.put(SpatialIndexProvider.GEOMETRY_TYPE,LayerNodeIndex.POINT_PARAMETER);
    layerIndex=new LayerNodeIndex("layerIndex",graphDb,spatialConfig);
    nodeIndices.put(NodeIndex.layer,layerIndex);
    logger.log(Level.FINE,"Layer index ready.");
    logger.log(Level.FINE,"Initializing node factory...");
    relUuidIndex=graphDb.index().forRelationships("uuidAllRelationships",LuceneIndexImplementation.EXACT_CONFIG);
    relIndices.put(RelationshipIndex.rel_uuid,relUuidIndex);
    logger.log(Level.FINE,"Relationship UUID index ready.");
    logger.log(Level.FINE,"Initializing relationship index...");
    relFulltextIndex=graphDb.index().forRelationships("fulltextAllRelationships",LuceneIndexImplementation.FULLTEXT_CONFIG);
    relIndices.put(RelationshipIndex.rel_fulltext,relFulltextIndex);
    logger.log(Level.FINE,"Relationship fulltext index ready.");
    logger.log(Level.FINE,"Initializing keyword relationship index...");
    relKeywordIndex=graphDb.index().forRelationships("keywordAllRelationships",LuceneIndexImplementation.EXACT_CONFIG);
    relIndices.put(RelationshipIndex.rel_keyword,relKeywordIndex);
    tx.success();
  }
 catch (  Throwable t) {
    logger.log(Level.WARNING,"Error while initializing indexes.",t);
  }
  logger.log(Level.FINE,"Relationship numeric index ready.");
  logger.log(Level.FINE,"Initializing relationship factory...");
  logger.log(Level.FINE,"Relationship factory ready.");
  cypherExecutionEngine=new ExecutionEngine(graphDb);
  logger.log(Level.FINE,"Cypher execution engine ready.");
  isInitialized=true;
}
