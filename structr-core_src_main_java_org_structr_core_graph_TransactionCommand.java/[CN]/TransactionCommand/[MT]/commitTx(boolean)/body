{
  final TransactionReference tx=transactions.get();
  if (tx != null && tx.isToplevel()) {
    final ModificationQueue modificationQueue=queues.get();
    final ErrorBuffer errorBuffer=buffers.get();
    for (    final StructrTransactionListener listener : listeners) {
      listener.beforeCommit(securityContext,modificationQueue.getModificationEvents(),tx.getSource());
    }
    if (doValidation) {
      if (!modificationQueue.doInnerCallbacks(securityContext,errorBuffer)) {
        tx.failure();
        throw new FrameworkException(422,errorBuffer);
      }
      if (!modificationQueue.doPostProcessing(securityContext,errorBuffer)) {
        tx.failure();
        throw new FrameworkException(422,errorBuffer);
      }
    }
    Set<String> synchronizationKeys=modificationQueue.getSynchronizationKeys();
    System.out.println("Waiting for semaphore on " + synchronizationKeys);
    try {
      semaphore.acquire(synchronizationKeys);
    }
 catch (    InterruptedException iex) {
      return;
    }
    System.out.println("Got semaphore on " + synchronizationKeys);
    if (!modificationQueue.doValidation(securityContext,errorBuffer,doValidation)) {
      tx.failure();
      semaphore.release(synchronizationKeys);
      throw new FrameworkException(422,errorBuffer);
    }
    try {
      tx.success();
    }
 catch (    Throwable t) {
      t.printStackTrace();
    }
    semaphore.release(synchronizationKeys);
  }
}
