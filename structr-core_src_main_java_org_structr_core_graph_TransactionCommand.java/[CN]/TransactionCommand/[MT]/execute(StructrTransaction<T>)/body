{
  GraphDatabaseService graphDb=(GraphDatabaseService)arguments.get("graphDb");
  FrameworkException error=null;
  Transaction tx=graphDb.beginTx();
  boolean topLevel=!(tx instanceof PlaceboTransaction);
  T result=null;
  if (topLevel) {
    this.changeSet=new TransactionChangeSet();
    currentCommand.set(this);
  }
  try {
    result=transaction.execute();
    if (topLevel && !changeSet.systemOnly()) {
      ErrorBuffer errorBuffer=new ErrorBuffer();
      callBeforeMethods(changeSet,errorBuffer);
      if (errorBuffer.hasError()) {
        error=new FrameworkException(422,errorBuffer);
        throw new IllegalStateException();
      }
      callAfterMethods(changeSet);
    }
    tx.success();
  }
 catch (  Throwable t) {
    tx.failure();
  }
 finally {
    tx.finish();
  }
  if (topLevel) {
    currentCommand.remove();
  }
  if (error != null) {
    throw error;
  }
  return result;
}
