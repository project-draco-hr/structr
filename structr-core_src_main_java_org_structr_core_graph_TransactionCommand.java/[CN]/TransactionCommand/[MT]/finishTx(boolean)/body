{
  final TransactionReference tx=transactions.get();
  if (tx != null) {
    if (tx.isToplevel()) {
      final ModificationQueue modificationQueue=queues.get();
      queues.remove();
      buffers.remove();
      currentCommand.remove();
      transactions.remove();
      try {
        tx.close();
      }
 catch (      Throwable t) {
        t.printStackTrace();
      }
      if (doCallbacks && modificationQueue != null && tx.isSuccessful()) {
        final GraphDatabaseService graphDb=(GraphDatabaseService)arguments.get("graphDb");
        try (final Transaction callbackTx=graphDb.beginTx()){
          modificationQueue.doOuterCallbacks(securityContext);
          final List<ModificationEvent> modificationEvents=modificationQueue.getModificationEvents();
          for (          StructrTransactionListener listener : listeners) {
            listener.transactionCommited(securityContext,modificationEvents);
          }
          callbackTx.success();
        }
       }
      if (modificationQueue != null) {
        modificationQueue.clear();
      }
    }
 else {
      tx.end();
    }
  }
}
