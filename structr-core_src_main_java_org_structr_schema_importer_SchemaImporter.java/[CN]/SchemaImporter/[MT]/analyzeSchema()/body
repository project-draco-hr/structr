{
  final App app=StructrApp.getInstance();
  final GraphDatabaseService graphDb=app.command(GraphDatabaseCommand.class).execute();
  final ConfigurationProvider configuration=Services.getInstance().getConfigurationProvider();
  final Set<NodeInfo> nodeTypes=new LinkedHashSet<>();
  final Map<Long,TypeInfo> nodeTypeInfoMap=new LinkedHashMap<>();
  final Set<RelationshipInfo> relationships=new LinkedHashSet<>();
  final Map<String,SchemaNode> schemaNodes=new LinkedHashMap<>();
  final Map<NodeInfo,List<Node>> nodeMap=new LinkedHashMap<>();
  final Map<String,List<TypeInfo>> typeInfoTypeMap=new LinkedHashMap<>();
  final List<TypeInfo> reducedTypeInfos=new LinkedList<>();
  final List<TypeInfo> typeInfos=new LinkedList<>();
  Iterator<Relationship> relIterator=null;
  Iterator<Node> nodeIterator=null;
  logger.log(Level.INFO,"Fetching all nodes iterator..");
  try (final Tx tx=app.tx()){
    nodeIterator=Iterables.filter(new StructrAndSpatialPredicate(false,false,true),GlobalGraphOperations.at(graphDb).getAllNodes()).iterator();
    tx.success();
  }
 catch (  FrameworkException fex) {
    fex.printStackTrace();
  }
  logger.log(Level.INFO,"Starting to analyze nodes..");
  NodeServiceCommand.bulkGraphOperation(SecurityContext.getSuperUserInstance(),nodeIterator,200,"Analyzing nodes",new BulkGraphOperation<Node>(){
    @Override public void handleGraphObject(    final SecurityContext securityContext,    final Node node) throws FrameworkException {
      final NodeInfo nodeInfo=new NodeInfo(node);
      nodeTypes.add(nodeInfo);
      List<Node> nodes=nodeMap.get(nodeInfo);
      if (nodes == null) {
        nodes=new LinkedList<>();
        nodeMap.put(nodeInfo,nodes);
      }
      nodes.add(node);
    }
    @Override public void handleThrowable(    SecurityContext securityContext,    Throwable t,    Node currentObject){
    }
    @Override public void handleTransactionFailure(    SecurityContext securityContext,    Throwable t){
    }
  }
);
  logger.log(Level.INFO,"Identifying common base classes..");
  identifyCommonBaseClasses(nodeTypes,nodeMap,typeInfos);
  logger.log(Level.INFO,"Collecting type information..");
  collectTypeInfos(typeInfos,typeInfoTypeMap);
  logger.log(Level.INFO,"Aggregating type information..");
  reduceTypeInfos(typeInfoTypeMap,reducedTypeInfos);
  logger.log(Level.INFO,"Identifying property sets..");
  intersectPropertySets(reducedTypeInfos);
  logger.log(Level.INFO,"Sorting result..");
  Collections.sort(reducedTypeInfos,new HierarchyComparator(false));
  logger.log(Level.INFO,"Starting with setting type and ID");
  final Map<String,TypeInfo> reducedTypeInfoMap=new LinkedHashMap<>();
  NodeServiceCommand.bulkGraphOperation(SecurityContext.getSuperUserInstance(),reducedTypeInfos.iterator(),200,"Setting type and ID",new BulkGraphOperation<TypeInfo>(){
    @Override public void handleGraphObject(    SecurityContext securityContext,    TypeInfo info) throws FrameworkException {
      final String type=info.getPrimaryType();
      reducedTypeInfoMap.put(type,info);
      for (      final Node node : info.getNodes()) {
        node.setProperty(GraphObject.id.dbName(),NodeServiceCommand.getNextUuid());
        node.setProperty(GraphObject.type.dbName(),type);
        nodeTypeInfoMap.put(node.getId(),info);
      }
    }
    @Override public void handleThrowable(    SecurityContext securityContext,    Throwable t,    TypeInfo currentObject){
    }
    @Override public void handleTransactionFailure(    SecurityContext securityContext,    Throwable t){
    }
  }
);
  logger.log(Level.INFO,"Fetching all relationships iterator..");
  try (final Tx tx=app.tx()){
    relIterator=Iterables.filter(new StructrAndSpatialPredicate(false,false,true),GlobalGraphOperations.at(graphDb).getAllRelationships()).iterator();
    tx.success();
  }
 catch (  FrameworkException fex) {
    fex.printStackTrace();
  }
  logger.log(Level.INFO,"Starting with analyzing relationships..");
  NodeServiceCommand.bulkGraphOperation(SecurityContext.getSuperUserInstance(),relIterator,200,"Analyzing relationships",new BulkGraphOperation<Relationship>(){
    @Override public void handleGraphObject(    SecurityContext securityContext,    Relationship rel) throws FrameworkException {
      final Node startNode=rel.getStartNode();
      final Node endNode=rel.getEndNode();
      if (startNode.hasProperty("type") && endNode.hasProperty("type")) {
        final TypeInfo startTypeInfo=nodeTypeInfoMap.get(startNode.getId());
        final TypeInfo endTypeInfo=nodeTypeInfoMap.get(endNode.getId());
        if (startTypeInfo == null || endTypeInfo == null) {
          return;
        }
        final String relationshipType=rel.getType().name();
        final String startNodeType=startTypeInfo.getPrimaryType();
        final String endNodeType=endTypeInfo.getPrimaryType();
        relationships.add(new RelationshipInfo(startNodeType,endNodeType,relationshipType));
        if (startNodeType != null && endNodeType != null) {
          final String combinedType=startNodeType.concat(relationshipType).concat(endNodeType);
          rel.setProperty(GraphObject.type.dbName(),combinedType);
        }
        rel.setProperty(GraphObject.id.dbName(),NodeServiceCommand.getNextUuid());
      }
    }
    @Override public void handleThrowable(    SecurityContext securityContext,    Throwable t,    Relationship currentObject){
    }
    @Override public void handleTransactionFailure(    SecurityContext securityContext,    Throwable t){
    }
  }
);
  logger.log(Level.INFO,"Grouping relationships..");
  final Map<String,List<RelationshipInfo>> relTypeInfoMap=new LinkedHashMap<>();
  for (  final RelationshipInfo relInfo : relationships) {
    final String relType=relInfo.getRelType();
    List<RelationshipInfo> infos=relTypeInfoMap.get(relType);
    if (infos == null) {
      infos=new LinkedList<>();
      relTypeInfoMap.put(relType,infos);
    }
    infos.add(relInfo);
  }
  logger.log(Level.INFO,"Aggregating relationship information..");
  final List<RelationshipInfo> reducedRelationshipInfos=new LinkedList<>();
  if ("true".equals(Services.getInstance().getConfigurationValue("importer.inheritancedetection","true"))) {
    for (    final List<RelationshipInfo> infos : relTypeInfoMap.values()) {
      reducedRelationshipInfos.addAll(reduceNodeTypes(infos,reducedTypeInfoMap));
    }
  }
 else {
    reducedRelationshipInfos.addAll(relationships);
  }
  logger.log(Level.INFO,"Starting with schema node creation..");
  NodeServiceCommand.bulkGraphOperation(SecurityContext.getSuperUserInstance(),reducedTypeInfos.iterator(),200,"Creating schema nodes",new BulkGraphOperation<TypeInfo>(){
    @Override public void handleGraphObject(    SecurityContext securityContext,    TypeInfo typeInfo) throws FrameworkException {
      final String type=typeInfo.getPrimaryType();
      if (!"ReferenceNode".equals(type)) {
        final Map<String,Class> props=typeInfo.getPropertySet();
        final PropertyMap propertyMap=new PropertyMap();
        for (        final Map.Entry<String,Class> propertyEntry : props.entrySet()) {
          final String propertyName=propertyEntry.getKey();
          final Class propertyType=propertyEntry.getValue();
          String propertyTypeName=propertyType.getSimpleName();
          if (propertyType.isArray()) {
            propertyTypeName=propertyTypeName.substring(0,propertyTypeName.length() - 2).concat("Array");
          }
          propertyMap.put(new StringProperty("_".concat(propertyName)),propertyTypeName);
        }
        propertyMap.put(AbstractNode.name,type);
        final Class existingType=configuration.getNodeEntityClass(type);
        if (existingType != null) {
          propertyMap.put(SchemaNode.extendsClass,existingType.getName());
        }
 else         if (!typeInfo.getOtherTypes().isEmpty()) {
          propertyMap.put(SchemaNode.extendsClass,typeInfo.getSuperclass(reducedTypeInfoMap));
        }
        schemaNodes.put(type,app.create(SchemaNode.class,propertyMap));
      }
    }
    @Override public void handleThrowable(    SecurityContext securityContext,    Throwable t,    TypeInfo currentObject){
    }
    @Override public void handleTransactionFailure(    SecurityContext securityContext,    Throwable t){
    }
  }
);
  logger.log(Level.INFO,"Starting with schema relationship creation..");
  NodeServiceCommand.bulkGraphOperation(SecurityContext.getSuperUserInstance(),reducedRelationshipInfos.iterator(),200,"Creating schema relationships",new BulkGraphOperation<RelationshipInfo>(){
    @Override public void handleGraphObject(    SecurityContext securityContext,    RelationshipInfo template) throws FrameworkException {
      final SchemaNode startNode=schemaNodes.get(template.getStartNodeType());
      final SchemaNode endNode=schemaNodes.get(template.getEndNodeType());
      final String relationshipType=template.getRelType();
      final PropertyMap propertyMap=new PropertyMap();
      propertyMap.put(SchemaRelationshipNode.sourceId,startNode.getUuid());
      propertyMap.put(SchemaRelationshipNode.targetId,endNode.getUuid());
      propertyMap.put(SchemaRelationshipNode.relationshipType,relationshipType);
      app.create(SchemaRelationshipNode.class,propertyMap);
    }
    @Override public void handleThrowable(    SecurityContext securityContext,    Throwable t,    RelationshipInfo currentObject){
    }
    @Override public void handleTransactionFailure(    SecurityContext securityContext,    Throwable t){
    }
  }
);
  logger.log(Level.INFO,"Starting with index rebuild..");
  app.command(BulkRebuildIndexCommand.class).execute(Collections.EMPTY_MAP);
}
