{
  return Actions.execute(securityContext,this,"${{\n\nvar pattern = Structr.get('this');\nvar page = pattern.sourcePage;\nvar subPatterns = pattern.subPatterns;\nvar from = pattern.from;\nvar to = pattern.to;\n\n//Structr.log('url: ' , page.url);\n\nvar content = Structr.GET(page.url, 'text/html');\nvar doc = org.jsoup.Jsoup.parse(content);\n//Structr.log(content);\n// var parts = content.split('\\n');\n\n//var parts = Structr.GET(page.url, 'text/html', pattern.selector);\nvar parts = doc.select(pattern.selector).toArray();\n\n//Structr.log(pattern.selector);\nStructr.log('extracted ', parts.length, ' elements from ', page.url, ' with selector ', pattern.selector);\n\nvar i = 1;\n\nif (from != null) {\n  i = from;\n}\n\nparts.every(function(part) {\n\n  //Structr.log('Extracted part: ', part);\n//  doc.body().html(part);\n  //Structr.log('document: ', doc);\n  \n  var obj = Structr.create(pattern.mappedType);\n\n\n  subPatterns.forEach(function(subPattern) {\n\n    var selector = pattern.selector + ':nth-child(' + i + ') > ' + subPattern.selector;\n    var ex = doc.select(selector).text();\n    Structr.log('(', parseInt(i).toString(), ') ', ex, ' from ', selector);\n\n    if (subPattern.mappedAttribute != null) {\n      obj[subPattern.mappedAttribute] = ex;\n    } else if (subPattern.subPage != null) {\n\n      var subUrl = page.url.match(/^(?:https?:\\/\\/)?(\u200C\u200B?:[^@\\/\\n]+@)?(?:www\\\u200C\u200B.)?([^:\\/\\n]+)/im)[0] + doc.select(selector).attr('href');\n      Structr.log('sub href: ', subUrl);\n      var subContent = Structr.GET(subUrl, 'text/html');\n      //Structr.log('sub content: ', subContent);\n      Structr.log('sub page: ', subPattern.subPage);\n      \n      var subDoc = org.jsoup.Jsoup.parse(subContent);\n\n      subPattern.subPage.patterns.forEach(function(subPagePattern) {\n\n        Structr.log('sub page selector: ', subPagePattern.selector);\n        var subEx = subDoc.select(subPagePattern.selector).text();\n        Structr.log('sub ex: ', subEx);\n\n        if (subPagePattern.mappedType != null) {\n\n          Structr.log('sub page pattern has mapped type: ', subPagePattern.mappedType);\n          Structr.log('sub page pattern selector: ', subPagePattern.selector);\n          var subParts = subDoc.select(subPagePattern.selector).toArray();\n\n          Structr.log(subParts.length, ' sub page pattern parts found');\n\n          var j = 1;\n\n          subParts.every(function(subPart) {\n\n            Structr.log('found sub page pattern part: ', subPart);\n\n            var subObj = Structr.create(subPagePattern.mappedType);\n\n            subPagePattern.subPatterns.forEach(function(subPageSubPattern) {\n\n              var subPageSubPatternSelector = subPagePattern.selector + ':nth-child(' + j + ') > ' + subPageSubPattern.selector;\n\n              var subSubEx = subDoc.select(subPageSubPatternSelector).text();\n              Structr.log('sub sub ex: ', subSubEx);\n              Structr.log('sub page sub selector: ', subPageSubPatternSelector);\n\n              if (subSubEx != null && subSubEx !== '' && subPageSubPattern.mappedAttribute != null) {\n                subObj[subPageSubPattern.mappedAttribute] = subSubEx;\n              }\n\n            });\n\n            obj[subPagePattern.mappedAttribute].push(subObj);\n\n          });\n\n        } else {\n\n          if (subEx != null && subEx !== '' && subPagePattern.mappedAttribute != null) {\n            obj[subPagePattern.mappedAttribute] = subEx;\n          }\n        }\n\n        j++;\n        return true;\n\n      });\n\n    }\n\n  });\n\n  if (to != null && to == i) {\n    return false;\n  }\n\n  i++;\n  return true;\n\n});\n\nStructr.log('######### extraction finished ############');\n\n}}",parameters);
}
