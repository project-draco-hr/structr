{
  term.flush();
  if (StringUtils.isNotBlank(line)) {
    if (insideOfBlockOrStructure()) {
      buf.append(line);
      buf.append("\r\n");
    }
 else {
      buf.append(line);
    }
    if ("exit".equals(line) || "quit".equals(line)) {
      term.stopEmulator();
    }
 else {
      checkForBlockChars(line.trim());
      if (!insideOfBlockOrStructure()) {
        commandHistory.add(buf.toString());
        try (final Tx tx=StructrApp.getInstance(console.getSecurityContext()).tx()){
          console.run(buf.toString(),term);
          tx.success();
        }
 catch (        Throwable t) {
          final String message=t.getMessage();
          if (message != null) {
            term.println(message);
          }
 else {
            t.printStackTrace();
            term.println(t.getClass().getSimpleName() + " encountered.");
          }
        }
        clearBlockStatus();
      }
    }
  }
}
