{
  int hashCode=-1;
  if (source != null) {
    hashCode=source.hashCode();
    visitedObjects.add(hashCode);
  }
  writer.beginObject(source);
  if (depth <= outputNestingDepth) {
    Iterable<PropertyKey> keys=source.getPropertyKeys(localPropertyView);
    if (keys != null) {
      final PermissionResolutionMask permissionResolutionMask=source.getPermissionResolutionMask();
      if (compactNestedProperties && depth > 0 && PropertyView.Ui.equals(localPropertyView)) {
        keys=idNameOnly;
      }
      for (      PropertyKey key : keys) {
        if (permissionResolutionMask == null || permissionResolutionMask.allowsProperty(key)) {
          final QueryRange range=writer.getSecurityContext().getRange(key.jsonName());
          if (range != null) {
            range.resetCount();
          }
          final Object value=source.getProperty(key,range);
          final PropertyKey localKey=key;
          if (value != null) {
            if (!(reduceRedundancy && visitedObjects.contains(value.hashCode()))) {
              writer.name(localKey.jsonName());
              serializeProperty(writer,key,value,localPropertyView,depth + 1);
            }
          }
 else {
            writer.name(localKey.jsonName()).nullValue();
          }
        }
      }
    }
  }
  writer.endObject(source);
  visitedObjects.remove(hashCode);
}
