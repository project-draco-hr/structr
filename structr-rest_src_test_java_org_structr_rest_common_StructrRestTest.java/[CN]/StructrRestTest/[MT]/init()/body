{
  String name="structr-rest-test-" + System.nanoTime();
  basePath="/tmp/" + name;
  try {
    File basePathFile=new File(basePath);
    basePathFile.mkdirs();
    String sourceJarName=getClass().getProtectionDomain().getCodeSource().getLocation().toString();
    File confFile=checkStructrConf(basePath,sourceJarName);
    List<Connector> connectors=new LinkedList<>();
    HandlerCollection handlerCollection=new HandlerCollection();
    server=new Server(httpPort);
    ServletContextHandler servletContext=new ServletContextHandler(server,contextPath,ServletContextHandler.SESSIONS);
    servletContext.setBaseResource(new ResourceCollection(Resource.newResource(basePath),JarResource.newJarResource(Resource.newResource(sourceJarName))));
    servletContext.setInitParameter("configfile.path",basePath + "/structr.conf");
    JsonRestServlet structrRestServlet=new JsonRestServlet(new TestResourceProvider(),PropertyView.Public,AbstractNode.uuid);
    ServletHolder structrRestServletHolder=new ServletHolder(structrRestServlet);
    Map<String,String> servletParams=new LinkedHashMap<>();
    servletParams.put("Authenticator",SuperUserAuthenticator.class.getName());
    structrRestServletHolder.setInitParameters(servletParams);
    structrRestServletHolder.setInitOrder(0);
    Map<String,ServletHolder> servlets=new LinkedHashMap<>();
    servlets.put(restUrl + "/*",structrRestServletHolder);
    int position=1;
    for (    Map.Entry<String,ServletHolder> servlet : servlets.entrySet()) {
      String path=servlet.getKey();
      ServletHolder servletHolder=servlet.getValue();
      servletHolder.setInitOrder(position++);
      logger.log(Level.INFO,"Adding servlet {0} for {1}",new Object[]{servletHolder,path});
      servletContext.addServlet(servletHolder,path);
    }
    servletContext.addEventListener(new ApplicationContextListener());
    handlerCollection.addHandler(servletContext);
    server.setHandler(handlerCollection);
    if (host != null && !host.isEmpty() && httpPort > -1) {
      SelectChannelConnector httpConnector=new SelectChannelConnector();
      httpConnector.setHost(host);
      httpConnector.setPort(httpPort);
      httpConnector.setMaxIdleTime(30000);
      httpConnector.setRequestHeaderSize(8192);
      connectors.add(httpConnector);
    }
 else {
      logger.log(Level.WARNING,"Unable to configure REST port, please make sure that application.host, application.http.port and application.rest.path are set correctly in structr.conf.");
    }
    if (!connectors.isEmpty()) {
      server.setConnectors(connectors.toArray(new Connector[0]));
    }
 else {
      logger.log(Level.SEVERE,"No connectors configured, aborting.");
      System.exit(0);
    }
    server.setGracefulShutdown(1000);
    server.setStopAtShutdown(true);
    server.start();
    running=server.isRunning();
  }
 catch (  Throwable t) {
    t.printStackTrace();
  }
}
