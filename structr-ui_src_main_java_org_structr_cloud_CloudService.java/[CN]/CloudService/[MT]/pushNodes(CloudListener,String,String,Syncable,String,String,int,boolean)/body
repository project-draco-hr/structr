{
  final ExportContext context=new ExportContext(listener,4);
  ClientConnection client=null;
  try (final Tx tx=StructrApp.getInstance().tx()){
    client=new ClientConnection(new Socket(remoteHost,remoteTcpPort));
    int sequenceNumber=0;
    final ExportSet exportSet=getExportSet((Syncable)sourceNode,SyncState.all(),recursive);
    context.increaseTotal(exportSet.getTotalSize());
    context.transmissionStarted();
    client.start();
    client.send(new BeginPacket());
    context.progress();
    final Message ack=client.waitForMessage();
    if (!(ack instanceof AckPacket)) {
      return;
    }
    client.send(new AuthenticationContainer(userName));
    context.progress();
    final Message authMessage=client.waitForMessage();
    if (authMessage instanceof AuthenticationContainer) {
      final AuthenticationContainer auth=(AuthenticationContainer)authMessage;
      client.setEncryptionKey(auth.getEncryptionKey(password));
      client.send(new PushNodeRequestContainer(remoteTargetNodeId));
      context.progress();
      client.waitForMessage();
      sequenceNumber=0;
      final Set<NodeInterface> nodes=exportSet.getNodes();
      for (      final NodeInterface n : nodes) {
        if (n instanceof File) {
          sendFile(context,client,(File)n,CloudService.CHUNK_SIZE);
        }
 else {
          client.send(new NodeDataContainer(n,sequenceNumber));
          context.progress();
          if (((sequenceNumber + 1) % LIVE_PACKET_COUNT) == 0) {
            client.waitForMessage();
          }
          sequenceNumber++;
        }
      }
      sequenceNumber=0;
      Set<RelationshipInterface> rels=exportSet.getRelationships();
      for (      RelationshipInterface r : rels) {
        if (nodes.contains(r.getSourceNode()) && nodes.contains(r.getTargetNode())) {
          client.send(new RelationshipDataContainer(r,sequenceNumber));
          context.progress();
          if (((sequenceNumber + 1) % LIVE_PACKET_COUNT) == 0) {
            client.waitForMessage();
          }
          sequenceNumber++;
        }
      }
    }
 else {
      if (context != null) {
        context.transmissionAborted();
      }
    }
    client.send(new EndPacket());
    context.progress();
    client.waitForMessage();
    client.waitForClose(2000);
    client.shutdown();
    if (context != null) {
      context.transmissionFinished();
    }
  }
 catch (  IOException|InvalidKeyException ioex) {
    throw new FrameworkException(504,"Unable to connect to remote server: " + ioex.getMessage());
  }
 finally {
    if (client != null) {
      client.shutdown();
    }
  }
}
