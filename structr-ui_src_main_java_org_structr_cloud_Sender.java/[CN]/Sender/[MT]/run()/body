{
  while (connection.isConnected()) {
    if (messagesInFlight < CloudService.LIVE_PACKET_COUNT) {
      try {
        final Message message=outputQueue.poll();
        if (message != null) {
          message.serialize(writer);
          writer.flush();
          messagesInFlight++;
          message.afterSend(connection);
        }
      }
 catch (      Throwable t) {
        t.printStackTrace();
        connection.close();
      }
    }
 else {
      Thread.yield();
    }
  }
}
