{
  final String uuid=UUID.randomUUID().toString().replaceAll("[\\-]+","");
  String contentType;
  final String relativeFilePath=File.getDirectoryPath(uuid) + "/" + uuid;
  final String filePath=FileHelper.getFilePath(relativeFilePath);
  final java.io.File fileOnDisk=new java.io.File(filePath);
  fileOnDisk.getParentFile().mkdirs();
  long size;
  long checksum;
  URL downloadUrl;
  try {
    downloadUrl=new URL(originalUrl,downloadAddress);
    logger.log(Level.INFO,"Starting download from {0}",downloadUrl);
    FileUtils.copyURLToFile(downloadUrl,fileOnDisk);
  }
 catch (  IOException ioe) {
    if (originalUrl == null || address == null) {
      logger.log(Level.INFO,"Cannot download from {0} without base address",downloadAddress);
      return null;
    }
    logger.log(Level.WARNING,"Unable to download from {0} {1}",new Object[]{originalUrl,downloadAddress});
    try {
      logger.log(Level.INFO,"Starting download from alternative URL {0} {1} {2}",new Object[]{originalUrl,address.concat("/"),downloadAddress});
      downloadUrl=new URL(new URL(originalUrl,address.concat("/")),downloadAddress);
      FileUtils.copyURLToFile(downloadUrl,fileOnDisk);
    }
 catch (    MalformedURLException ex) {
      logger.log(Level.SEVERE,"Could not resolve address {0}",address.concat("/"));
      return null;
    }
catch (    IOException ex) {
      logger.log(Level.WARNING,"Unable to download from {0}",address.concat("/"));
      return null;
    }
    logger.log(Level.INFO,"Starting download from alternative URL {0}",downloadUrl);
  }
  downloadAddress=StringUtils.substringBefore(downloadAddress,"?");
  final String fileName=PathHelper.getName(downloadAddress);
  try {
    contentType=FileHelper.getContentMimeType(fileOnDisk,fileName);
    size=fileOnDisk.length();
    checksum=FileUtils.checksumCRC32(fileOnDisk);
  }
 catch (  IOException ioe) {
    logger.log(Level.WARNING,"Unable to determine MIME type, size or checksum of {0}",fileOnDisk);
    return null;
  }
  String httpPrefix="http://";
  logger.log(Level.INFO,"Download URL: {0}, address: {1}, cleaned address: {2}",new Object[]{downloadUrl,address,StringUtils.substringBeforeLast(address,"/")});
  String relativePath=StringUtils.substringAfter(downloadUrl.toString(),StringUtils.substringBeforeLast(address,"/"));
  if (StringUtils.isBlank(relativePath)) {
    relativePath=downloadAddress;
  }
  String path=StringUtils.substringBefore(((downloadAddress.contains(httpPrefix)) ? StringUtils.substringAfter(downloadAddress,"http://") : relativePath),fileName);
  logger.log(Level.INFO,"Relative path: {0}, final path: {1}",new Object[]{relativePath,path});
  if (contentType.equals("text/plain")) {
    contentType=StringUtils.defaultIfBlank(contentTypeForExtension.get(StringUtils.substringAfterLast(fileName,".")),"text/plain");
  }
  final String ct=contentType;
  try {
    if (!(fileExists(fileName,checksum))) {
      File fileNode;
      if (ImageHelper.isImageType(fileName)) {
        fileNode=createImageNode(uuid,fileName,ct,size,checksum);
      }
 else {
        fileNode=createFileNode(uuid,fileName,ct,size,checksum);
      }
      if (fileNode != null) {
        Folder parent=FileHelper.createFolderPath(securityContext,path);
        if (parent != null) {
          fileNode.setProperty(File.parent,parent);
        }
        if (contentType.equals("text/css")) {
          processCssFileNode(fileNode);
        }
      }
      return fileNode;
    }
 else {
      fileOnDisk.delete();
    }
  }
 catch (  FrameworkException|IOException fex) {
    logger.log(Level.WARNING,"Could not create file node.",fex);
  }
  return null;
}
