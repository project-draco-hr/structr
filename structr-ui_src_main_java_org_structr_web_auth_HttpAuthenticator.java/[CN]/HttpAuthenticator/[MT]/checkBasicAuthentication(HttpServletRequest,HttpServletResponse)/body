{
  Principal user;
  String auth=request.getHeader("Authorization");
  try {
    if (auth == null) {
      sendBasicAuthResponse(response);
      return null;
    }
    if (!auth.toUpperCase().startsWith("BASIC ")) {
      sendBasicAuthResponse(response);
      return null;
    }
    String[] userAndPass=getUsernameAndPassword(request);
    try {
      if ((userAndPass == null) || (userAndPass.length != 2)) {
        writeUnauthorized(response);
      }
      user=AuthHelper.getPrincipalForPassword(Person.eMail,userAndPass[0],userAndPass[1]);
    }
 catch (    Exception ex) {
      sendBasicAuthResponse(response);
      return null;
    }
    return user;
  }
 catch (  IllegalStateException ise) {
    logger.log(Level.WARNING,"Error while sending basic auth response, stream might be already closed, sending anyway.");
  }
  return null;
}
