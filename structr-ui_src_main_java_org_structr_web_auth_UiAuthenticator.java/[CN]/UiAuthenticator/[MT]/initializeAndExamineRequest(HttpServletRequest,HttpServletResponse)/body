{
  SecurityContext securityContext;
  Principal user=checkSessionAuthentication(request);
  if (user == null) {
    user=checkExternalAuthentication(request,response);
  }
  if (user == null) {
    user=getUser(request,true);
  }
  if (user == null) {
    securityContext=SecurityContext.getInstance(user,request,AccessMode.Frontend);
  }
 else {
    if (user instanceof SuperUser) {
      securityContext=SecurityContext.getSuperUserInstance(request);
    }
 else {
      securityContext=SecurityContext.getInstance(user,request,AccessMode.Backend);
    }
  }
  securityContext.setAuthenticator(this);
  String origin=request.getHeader("Origin");
  if (!StringUtils.isBlank(origin)) {
    final Services services=Services.getInstance();
    response.setHeader("Access-Control-Allow-Origin",origin);
    response.setHeader("Access-Control-MaxAge",services.getConfigurationValue(Services.ACCESS_CONTROL_MAX_AGE));
    response.setHeader("Access-Control-Allow-Methods",services.getConfigurationValue(Services.ACCESS_CONTROL_ALLOW_METHODS));
    response.setHeader("Access-Control-Allow-Headers",services.getConfigurationValue(Services.ACCESS_CONTROL_ALLOW_HEADERS));
    response.setHeader("Access-Control-Allow-Credentials",services.getConfigurationValue(Services.ACCESS_CONTROL_ALLOW_CREDENTIALS));
    response.setHeader("Access-Control-Expose-Headers",services.getConfigurationValue(Services.ACCESS_CONTROL_EXPOSE_HEADERS));
  }
  examined=true;
  return securityContext;
}
