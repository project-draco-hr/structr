{
  SecurityContext securityContext;
  Principal user=checkSessionAuthentication(request);
  if (user == null) {
    user=checkExternalAuthentication(request,response);
  }
  if (user == null) {
    user=getUser(request,true);
  }
  if (user == null) {
    securityContext=SecurityContext.getInstance(user,request,AccessMode.Frontend);
  }
 else {
    if (user instanceof SuperUser) {
      securityContext=SecurityContext.getSuperUserInstance(request);
    }
 else {
      securityContext=SecurityContext.getInstance(user,request,AccessMode.Backend);
    }
  }
  securityContext.setAuthenticator(this);
  String origin=request.getHeader("Origin");
  if (!StringUtils.isBlank(origin)) {
    response.setHeader("Access-Control-Allow-Origin",origin);
    response.setHeader("Access-Control-Allow-Methods","GET,PUT,POST,DELETE,HEAD,OPTIONS");
    response.setHeader("Access-Control-Allow-Headers","Content-Type,Location");
  }
  examined=true;
  return securityContext;
}
