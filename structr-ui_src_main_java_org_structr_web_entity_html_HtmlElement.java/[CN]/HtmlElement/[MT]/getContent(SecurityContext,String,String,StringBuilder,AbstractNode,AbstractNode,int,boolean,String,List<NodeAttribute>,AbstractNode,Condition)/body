{
  String localComponentId=componentId;
  String content=null;
  String tag=null;
  String ind="";
  HttpServletRequest request=securityContext.getRequest();
  HtmlElement el=null;
  boolean isVoid=(startNode instanceof HtmlElement) && ((HtmlElement)startNode).isVoidElement();
  if (startNode instanceof Component) {
    depth--;
  }
  if (startNode instanceof HtmlElement) {
    el=(HtmlElement)startNode;
    if (!el.avoidWhitespace()) {
      ind=indent(depth,true);
    }
  }
  if (startNode != null) {
    String id=startNode.getUuid();
    tag=startNode.getProperty(HtmlElement.tag);
    if (startNode instanceof Component && searchClass != null) {
      String kind=startNode.getProperty(Component.kind);
      if ((kind != null) && kind.equals(EntityContext.normalizeEntityName(searchClass)) && (attrs != null)) {
        for (        NodeAttribute attr : attrs) {
          PropertyKey key=attr.getKey();
          java.lang.Object val=attr.getValue();
          if (!val.equals(startNode.getProperty(key))) {
            return;
          }
        }
      }
    }
    if (startNode instanceof Content) {
      Content contentNode=(Content)startNode;
      content=contentNode.getPropertyWithVariableReplacement(request,page,pageId,componentId,viewComponent,Content.content);
      String contentType=contentNode.getProperty(Content.contentType);
      if (contentType != null) {
        Adapter<String,String> converter=contentConverters.get(contentType);
        if (converter != null) {
          try {
            content=converter.adapt(content);
          }
 catch (          FrameworkException fex) {
            logger.log(Level.WARNING,"Unable to convert content: {0}",fex.getMessage());
          }
        }
      }
      if (((contentType == null) || contentType.equals("text/plain")) && (content != null) && !content.isEmpty()) {
        content=content.replaceAll("[\\n]{1}","<br>");
      }
    }
    if (startNode instanceof Component) {
      localComponentId=startNode.getProperty(AbstractNode.uuid);
    }
    if (edit && inBody && (startNode instanceof Content)) {
      tag="span";
    }
    if (StringUtils.isNotBlank(tag)) {
      if (tag.equals("body")) {
        inBody=true;
      }
      if ((startNode instanceof Content) || (startNode instanceof HtmlElement)) {
        double start=System.nanoTime();
        buffer.append("<").append(tag);
        if (edit && (id != null)) {
          if (depth == 1) {
            buffer.append(" structr_page_id='").append(pageId).append("'");
          }
          if (el != null) {
            buffer.append(" structr_element_id=\"").append(id).append("\"");
            buffer.append(" structr_type=\"").append(startNode.getType()).append("\"");
            buffer.append(" structr_name=\"").append(startNode.getName()).append("\"");
          }
 else {
            buffer.append(" structr_content_id=\"").append(id).append("\"");
          }
        }
        if (el != null) {
          for (          PropertyKey attribute : EntityContext.getPropertySet(startNode.getClass(),PropertyView.Html)) {
            try {
              String value=el.getPropertyWithVariableReplacement(page,pageId,localComponentId,viewComponent,attribute);
              if ((value != null) && StringUtils.isNotBlank(value)) {
                String key=attribute.jsonName().substring(PropertyView.Html.length());
                buffer.append(" ").append(key).append("=\"").append(value).append("\"");
              }
            }
 catch (            Throwable t) {
              t.printStackTrace();
            }
          }
        }
        buffer.append(">");
        if (!isVoid) {
          buffer.append(ind);
        }
        double end=System.nanoTime();
        logger.log(Level.FINE,"Render node {0} in {1} seconds",new java.lang.Object[]{startNode.getUuid(),decimalFormat.format((end - start) / 1000000000.0)});
      }
    }
    if (content != null) {
      buffer.append(content);
    }
    if (startNode instanceof SearchResultView) {
      double startSearchResultView=System.nanoTime();
      String searchString=(String)request.getParameter("search");
      if ((request != null) && StringUtils.isNotBlank(searchString)) {
        for (        Page resultPage : getResultPages(securityContext,(Page)page)) {
          List<AbstractRelationship> rels=Component.getChildRelationships(request,startNode);
          for (          AbstractRelationship rel : rels) {
            if ((condition == null) || ((condition != null) && condition.isSatisfied(request,rel))) {
              AbstractNode subNode=rel.getEndNode();
              if (subNode.isNotDeleted() && subNode.isNotDeleted()) {
                getContent(securityContext,pageId,localComponentId,buffer,page,subNode,depth,inBody,searchClass,attrs,resultPage,condition);
              }
            }
          }
        }
      }
      double endSearchResultView=System.nanoTime();
      logger.log(Level.FINE,"Get graph objects for search {0} in {1} seconds",new java.lang.Object[]{searchString,decimalFormat.format((endSearchResultView - startSearchResultView) / 1000000000.0)});
    }
 else     if (startNode instanceof View) {
      double startView=System.nanoTime();
      List<GraphObject> results=((View)startNode).getGraphObjects(request);
      double endView=System.nanoTime();
      logger.log(Level.FINE,"Get graph objects for {0} in {1} seconds",new java.lang.Object[]{startNode.getUuid(),decimalFormat.format((endView - startView) / 1000000000.0)});
      for (      GraphObject result : results) {
        List<AbstractRelationship> rels=Component.getChildRelationships(request,startNode);
        for (        AbstractRelationship rel : rels) {
          if ((condition == null) || ((condition != null) && condition.isSatisfied(request,rel))) {
            AbstractNode subNode=rel.getEndNode();
            if (subNode.isNotDeleted() && subNode.isNotDeleted()) {
              getContent(securityContext,pageId,localComponentId,buffer,page,subNode,depth,inBody,searchClass,attrs,(AbstractNode)result,condition);
            }
          }
        }
      }
    }
 else     if (startNode instanceof Condition) {
      List<AbstractRelationship> rels=Component.getChildRelationships(request,startNode);
      Condition newCondition=(Condition)startNode;
      for (      AbstractRelationship rel : rels) {
        AbstractNode subNode=rel.getEndNode();
        if (subNode.isNotDeleted() && subNode.isNotDeleted()) {
          getContent(securityContext,pageId,localComponentId,buffer,page,subNode,depth + 1,inBody,searchClass,attrs,viewComponent,newCondition);
        }
      }
    }
 else {
      List<AbstractRelationship> rels=Component.getChildRelationships(request,startNode);
      for (      AbstractRelationship rel : rels) {
        if ((condition == null) || ((condition != null) && condition.isSatisfied(request,rel))) {
          AbstractNode subNode=rel.getEndNode();
          if (subNode.isNotDeleted() && subNode.isNotDeleted()) {
            getContent(securityContext,pageId,localComponentId,buffer,page,subNode,depth + 1,inBody,searchClass,attrs,viewComponent,condition);
          }
        }
      }
    }
    boolean whitespaceOnly=false;
    int lastNewline=buffer.lastIndexOf("\n");
    whitespaceOnly=StringUtils.isBlank((lastNewline > -1) ? buffer.substring(lastNewline) : buffer.toString());
    if ((el != null) && !el.avoidWhitespace()) {
      if (whitespaceOnly) {
        buffer.replace(buffer.length() - 2,buffer.length(),"");
      }
 else {
        buffer.append(indent(depth - 1,true));
      }
    }
    if ((startNode instanceof HtmlElement || startNode instanceof Content) && StringUtils.isNotBlank(tag) && (!isVoid)) {
      buffer.append("</").append(tag).append(">");
      if ((el != null) && !el.avoidWhitespace()) {
        buffer.append(indent(depth - 1,true));
      }
    }
  }
}
