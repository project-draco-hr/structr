{
  if (propertySet.containsKey(User.email.jsonName()) && propertySet.size() == 1) {
    SecurityContext superUserContext=SecurityContext.getSuperUserInstance();
    final Principal user;
    final String emailString=(String)propertySet.get(User.email.jsonName());
    if (StringUtils.isEmpty(emailString)) {
      return new RestMethodResult(HttpServletResponse.SC_BAD_REQUEST);
    }
    localeString=(String)propertySet.get(MailTemplate.locale.jsonName());
    confKey=UUID.randomUUID().toString();
    Result result=Services.command(superUserContext,SearchNodeCommand.class).execute(Search.andExactType(User.class),Search.andExactProperty(superUserContext,User.email,emailString));
    if (!result.isEmpty()) {
      user=(Principal)result.get(0);
      Services.command(securityContext,TransactionCommand.class).execute(new StructrTransaction(){
        @Override public Object execute() throws FrameworkException {
          user.setProperty(User.confirmationKey,confKey);
          return null;
        }
      }
);
    }
 else {
      user=createUser(securityContext,emailString);
    }
    if (user != null) {
      if (!sendInvitationLink(user)) {
        return new RestMethodResult(HttpServletResponse.SC_BAD_REQUEST);
      }
    }
  }
  return new RestMethodResult(HttpServletResponse.SC_OK);
}
