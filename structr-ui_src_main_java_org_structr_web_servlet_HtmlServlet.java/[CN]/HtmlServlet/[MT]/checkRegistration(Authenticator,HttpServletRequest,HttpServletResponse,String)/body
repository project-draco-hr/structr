{
  logger.log(Level.FINE,"Checking registration ...");
  String key=request.getParameter(CONFIRM_KEY_KEY);
  if (StringUtils.isEmpty(key)) {
    return null;
  }
  String targetPage=request.getParameter(TARGET_PAGE_KEY);
  String errorPage=request.getParameter(ERROR_PAGE_KEY);
  if (CONFIRM_REGISTRATION_PAGE.equals(path)) {
    final App app=StructrApp.getInstance();
    Result<Principal> results;
    try (final Tx tx=app.tx()){
      results=app.nodeQuery(Principal.class).and(User.confirmationKey,key).getResult();
      ;
    }
     if (!results.isEmpty()) {
      final Principal user=results.get(0);
      try (final Tx tx=app.tx()){
        user.setProperty(User.confirmationKey,null);
        if (auth.getUserAutoLogin()) {
          String sessionIdFromRequest=null;
          try {
            sessionIdFromRequest=request.getRequestedSessionId();
          }
 catch (          UnsupportedOperationException uoe) {
          }
          if (sessionIdFromRequest != null) {
            AuthHelper.clearSession(sessionIdFromRequest);
            user.addSessionId(sessionIdFromRequest);
          }
        }
        tx.success();
        if (StringUtils.isNotBlank(targetPage)) {
          return "/" + targetPage;
        }
      }
     }
 else {
      if (StringUtils.isNotBlank(errorPage)) {
        return "/" + errorPage;
      }
    }
  }
  return null;
}
