{
  logger.log(Level.FINE,"Checking registration ...");
  String key=request.getParameter(CONFIRM_KEY_KEY);
  if (StringUtils.isEmpty(key)) {
    return false;
  }
  String targetPage=request.getParameter(TARGET_PAGE_KEY);
  String errorPage=request.getParameter(ERROR_PAGE_KEY);
  if (CONFIRM_REGISTRATION_PAGE.equals(path)) {
    List<SearchAttribute> searchAttrs=new LinkedList();
    searchAttrs.add(Search.andExactTypeAndSubtypes(Principal.class));
    searchAttrs.add(Search.andExactProperty(securityContext,User.confirmationKey,key));
    Result results=(Result)searchNodesAsSuperuser.execute(searchAttrs);
    if (!results.isEmpty()) {
      final Principal user=(Principal)results.get(0);
      final App app=StructrApp.getInstance(securityContext);
      try {
        app.beginTx();
        user.setProperty(User.confirmationKey,null);
        user.setProperty(Principal.sessionId,request.getSession().getId());
        app.commitTx();
      }
  finally {
        app.finishTx();
      }
      if (StringUtils.isNotBlank(targetPage)) {
        response.sendRedirect("/" + targetPage);
        return true;
      }
    }
 else {
      if (StringUtils.isNotBlank(errorPage)) {
        response.sendRedirect("/" + errorPage);
        return true;
      }
    }
  }
  return false;
}
