{
  if (!securityContext.isVisible(file)) {
    response.sendError(HttpServletResponse.SC_NOT_FOUND);
    return;
  }
  ServletOutputStream out=response.getOutputStream();
  if (!EditMode.DATA.equals(edit) && notModifiedSince(request,response,file)) {
    out.flush();
    out.close();
  }
 else {
    InputStream in=file.getInputStream();
    String contentType=file.getContentType();
    AsyncContext async=request.startAsync();
    out.setWriteListener(new StructrWriteListener(in,async,out));
    if (contentType != null) {
      response.setContentType(contentType);
    }
 else {
      response.setContentType("application/octet-stream");
    }
    response.setStatus(HttpServletResponse.SC_OK);
  }
}
