{
  try (final Tx tx=StructrApp.getInstance().tx()){
    if (!ServletFileUpload.isMultipartContent(request)) {
      response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
      response.getOutputStream().write("ERROR (400): Request does not contain multipart content.\n".getBytes("UTF-8"));
      return;
    }
    final SecurityContext securityContext=getConfig().getAuthenticator().initializeAndExamineRequest(request,response);
    if (securityContext.getUser(false) == null && Boolean.FALSE.equals(Boolean.parseBoolean(StructrApp.getConfigurationValue("UploadServlet.allowAnonymousUploads","false")))) {
      response.setStatus(HttpServletResponse.SC_FORBIDDEN);
      response.getOutputStream().write("ERROR (403): Anonymous uploads forbidden.\n".getBytes("UTF-8"));
      return;
    }
    securityContext.setAccessMode(AccessMode.Frontend);
    request.setCharacterEncoding("UTF-8");
    response.setCharacterEncoding("UTF-8");
    if (response.getStatus() == 302) {
      return;
    }
    final String pathInfo=request.getPathInfo();
    String type=null;
    if (StringUtils.isNotBlank(pathInfo)) {
      type=SchemaHelper.normalizeEntityName(StringUtils.stripStart(pathInfo.trim(),"/"));
    }
    uploader.setFileSizeMax(MAX_FILE_SIZE);
    uploader.setSizeMax(MAX_REQUEST_SIZE);
    response.setContentType("text/html");
    final PrintWriter out=response.getWriter();
    List<FileItem> fileItemsList=uploader.parseRequest(request);
    Iterator<FileItem> fileItemsIterator=fileItemsList.iterator();
    final Map<String,Object> params=new HashMap<>();
    while (fileItemsIterator.hasNext()) {
      final FileItem item=fileItemsIterator.next();
      if (item.isFormField()) {
        params.put(item.getFieldName(),item.getString());
      }
 else {
        try {
          final String contentType=item.getContentType();
          boolean isImage=(contentType != null && contentType.startsWith("image"));
          boolean isVideo=(contentType != null && contentType.startsWith("video"));
          if (params.containsKey(NodeInterface.type.jsonName())) {
            type=(String)params.get(NodeInterface.type.jsonName());
          }
          final Class cls=type != null ? SchemaHelper.getEntityClassForRawType(type) : (isImage ? Image.class : (isVideo ? VideoFile.class : org.structr.dynamic.File.class));
          final String name=item.getName().replaceAll("\\\\","/");
          final org.structr.dynamic.File newFile=FileHelper.createFile(securityContext,IOUtils.toByteArray(item.getInputStream()),contentType,cls);
          newFile.setProperty(AbstractNode.name,PathHelper.getName(name));
          newFile.setProperty(AbstractNode.visibleToPublicUsers,true);
          newFile.setProperty(AbstractNode.visibleToAuthenticatedUsers,true);
          PropertyMap additionalProperties=PropertyMap.inputTypeToJavaType(securityContext,cls,params);
          for (          PropertyKey key : additionalProperties.keySet()) {
            newFile.setProperty(key,additionalProperties.get(key));
          }
          out.write(newFile.getUuid());
        }
 catch (        IOException ex) {
          logger.log(Level.WARNING,"Could not upload file",ex);
        }
      }
    }
    tx.success();
  }
 catch (  FrameworkException|IOException|FileUploadException t) {
    t.printStackTrace();
    logger.log(Level.SEVERE,"Exception while processing request",t);
    UiAuthenticator.writeInternalServerError(response);
  }
}
