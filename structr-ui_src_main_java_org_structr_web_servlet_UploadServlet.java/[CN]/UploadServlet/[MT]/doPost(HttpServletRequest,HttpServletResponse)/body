{
  try (final Tx tx=StructrApp.getInstance().tx()){
    if (!ServletFileUpload.isMultipartContent(request)) {
      response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
      response.getOutputStream().write("ERROR (400): Request does not contain multipart content.\n".getBytes("UTF-8"));
      return;
    }
    final SecurityContext securityContext;
    try {
      securityContext=getConfig().getAuthenticator().initializeAndExamineRequest(request,response);
    }
 catch (    AuthenticationException ae) {
      response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
      response.getOutputStream().write("ERROR (401): Invalid user or password.\n".getBytes("UTF-8"));
      return;
    }
    if (securityContext.getUser(false) == null && Boolean.FALSE.equals(Boolean.parseBoolean(StructrApp.getConfigurationValue("UploadServlet.allowAnonymousUploads","false")))) {
      response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
      response.getOutputStream().write("ERROR (401): Anonymous uploads forbidden.\n".getBytes("UTF-8"));
      return;
    }
    securityContext.setAccessMode(AccessMode.Frontend);
    request.setCharacterEncoding("UTF-8");
    response.setCharacterEncoding("UTF-8");
    if (response.getStatus() == 302) {
      return;
    }
    final String pathInfo=request.getPathInfo();
    String type=null;
    if (StringUtils.isNotBlank(pathInfo)) {
      type=SchemaHelper.normalizeEntityName(StringUtils.stripStart(pathInfo.trim(),"/"));
    }
    uploader.setFileSizeMax(MEGABYTE * Long.parseLong(StructrApp.getConfigurationValue("UploadServlet.maxFileSize",MAX_FILE_SIZE)));
    uploader.setSizeMax(MEGABYTE * Long.parseLong(StructrApp.getConfigurationValue("UploadServlet.maxRequestSize",MAX_REQUEST_SIZE)));
    response.setContentType("text/html");
    final PrintWriter out=response.getWriter();
    List<FileItem> fileItemsList=uploader.parseRequest(request);
    Iterator<FileItem> fileItemsIterator=fileItemsList.iterator();
    final Map<String,Object> params=new HashMap<>();
    while (fileItemsIterator.hasNext()) {
      final FileItem item=fileItemsIterator.next();
      if (item.isFormField()) {
        params.put(item.getFieldName(),item.getString());
      }
 else {
        try {
          final String contentType=item.getContentType();
          boolean isImage=(contentType != null && contentType.startsWith("image"));
          boolean isVideo=(contentType != null && contentType.startsWith("video"));
          if (params.containsKey(NodeInterface.type.jsonName())) {
            type=(String)params.get(NodeInterface.type.jsonName());
          }
          Class cls=null;
          if (type != null) {
            cls=SchemaHelper.getEntityClassForRawType(type);
          }
 else {
            if (isImage) {
              cls=Image.class;
            }
 else             if (isVideo) {
              cls=SchemaHelper.getEntityClassForRawType("VideoFile");
              if (cls == null) {
                logger.log(Level.WARNING,"Unable to create entity of type VideoFile, class is not defined.");
              }
            }
 else {
              cls=org.structr.dynamic.File.class;
            }
          }
          final String name=item.getName().replaceAll("\\\\","/");
          final FileBase newFile=FileHelper.createFile(securityContext,IOUtils.toByteArray(item.getInputStream()),contentType,cls);
          newFile.setProperty(AbstractNode.name,PathHelper.getName(name));
          PropertyMap additionalProperties=PropertyMap.inputTypeToJavaType(securityContext,cls,params);
          for (          PropertyKey key : additionalProperties.keySet()) {
            newFile.setProperty(key,additionalProperties.get(key));
          }
          if (!newFile.validatePath(securityContext,null)) {
            newFile.setProperty(AbstractNode.name,name.concat("_").concat(FileHelper.getDateString()));
          }
          newFile.notifyUploadCompletion();
          out.write(newFile.getUuid());
        }
 catch (        IOException ex) {
          logger.log(Level.WARNING,"Could not upload file",ex);
        }
      }
    }
    tx.success();
  }
 catch (  FrameworkException|IOException|FileUploadException t) {
    logger.log(Level.SEVERE,"Exception while processing request",t);
    UiAuthenticator.writeInternalServerError(response);
  }
}
