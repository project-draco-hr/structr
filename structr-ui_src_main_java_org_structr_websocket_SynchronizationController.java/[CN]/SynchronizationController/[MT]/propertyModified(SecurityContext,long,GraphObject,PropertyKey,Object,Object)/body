{
  List<WebSocketMessage> messageStack=messageStackMap.get(transactionKey);
  WebSocketMessage message=new WebSocketMessage();
  message.setCommand("UPDATE");
  String uuid=graphObject.getProperty(AbstractNode.uuid);
  if (graphObject instanceof AbstractRelationship) {
    AbstractRelationship relationship=(AbstractRelationship)graphObject;
    AbstractNode startNode=relationship.getStartNode();
    AbstractNode endNode=relationship.getEndNode();
    try {
      PropertyMap relProperties=relationship.getProperties();
      relProperties.put(new StringProperty("startNodeId"),startNode.getUuid());
      relProperties.put(new StringProperty("endNodeId"),endNode.getUuid());
      Map<String,Object> properties=PropertyMap.javaTypeToInputType(securityContext,relationship.getClass(),relProperties);
      message.setRelData(properties);
    }
 catch (    FrameworkException fex) {
      logger.log(Level.WARNING,"Unable to convert properties from type {0} to input type",relationship.getClass());
    }
  }
 else   if (graphObject instanceof AbstractNode) {
    AbstractNode node=(AbstractNode)graphObject;
    try {
      registerPartialType(graphObject,transactionKey);
      Map<String,Object> nodeProperties=new HashMap<String,Object>();
      nodeProperties.put(key.dbName(),newValue);
      nodeProperties.put(AbstractNode.type.dbName(),node.getType());
      Map<String,Object> properties=PropertyMap.javaTypeToInputType(securityContext,node.getClass(),PropertyMap.databaseTypeToJavaType(securityContext,graphObject,nodeProperties));
      properties.remove(AbstractNode.type.jsonName());
      message.setNodeData(properties);
    }
 catch (    FrameworkException fex) {
      logger.log(Level.WARNING,"Unable to convert properties from type {0} to input type",node.getClass());
    }
  }
  message.setId(uuid);
  message.setGraphObject(graphObject);
  message.getModifiedProperties().add(key);
  messageStack.add(message);
}
