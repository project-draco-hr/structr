{
  final SecurityContext securityContext=getWebSocket().getSecurityContext();
  final Map<String,Object> nodeData=webSocketData.getNodeData();
  String nodeToAddId=(String)nodeData.get("id");
  String childContent=(String)nodeData.get("childContent");
  final Map<String,Object> relData=webSocketData.getRelData();
  String parentId=webSocketData.getId();
  if (parentId != null) {
    AbstractNode nodeToAdd=null;
    AbstractNode parentNode=getNode(parentId);
    if (nodeToAddId != null) {
      nodeToAdd=getNode(nodeToAddId);
    }
 else {
      StructrTransaction transaction=new StructrTransaction<AbstractNode>(){
        @Override public AbstractNode execute() throws FrameworkException {
          PropertyMap nodeProps=PropertyMap.inputTypeToJavaType(securityContext,nodeData);
          return Services.command(securityContext,CreateNodeCommand.class).execute(nodeProps);
        }
      }
;
      try {
        nodeToAdd=(AbstractNode)Services.command(securityContext,TransactionCommand.class).execute(transaction);
      }
 catch (      FrameworkException fex) {
        logger.log(Level.WARNING,"Could not create node.",fex);
        getWebSocket().send(MessageBuilder.status().code(fex.getStatus()).message(fex.getMessage()).build(),true);
      }
    }
    if ((nodeToAdd != null) && (parentNode != null)) {
      String originalPageId=(String)nodeData.get("sourcePageId");
      String newPageId=(String)nodeData.get("targetPageId");
      PropertyKey<Long> originalPageIdProperty=null;
      PropertyKey<Long> newPageIdProperty=null;
      if (originalPageId != null) {
        originalPageIdProperty=new LongProperty(originalPageId);
      }
      if (newPageId != null) {
        newPageIdProperty=new LongProperty(newPageId);
      }
{
        try {
          AbstractRelationship existingRel=null;
          long maxPos=0;
          for (          AbstractRelationship r : parentNode.getOutgoingRelationships(RelType.CONTAINS)) {
            if (r.getEndNode().equals(nodeToAdd) && originalPageIdProperty != null && r.getLongProperty(originalPageIdProperty) != null) {
              existingRel=r;
            }
            if (newPageIdProperty != null) {
              Long pos=r.getLongProperty(newPageIdProperty);
              if (pos != null) {
                maxPos=Math.max(pos,maxPos);
              }
            }
          }
          if (existingRel != null) {
            if (newPageIdProperty != null) {
              existingRel.setProperty(newPageIdProperty,Long.parseLong((String)relData.get(newPageId)));
              logger.log(Level.INFO,"Tagging relationship with pageId {0} and position {1}",new Object[]{newPageId,maxPos + 1});
            }
          }
 else {
            if (parentNode instanceof Page && !(nodeToAdd instanceof Html)) {
              logger.log(Level.SEVERE,"Trying to add non Html node to Page!");
            }
            relData.put(newPageId,maxPos + 1);
            PropertyMap relProperties=PropertyMap.inputTypeToJavaType(securityContext,relData);
            HtmlElement.children.createRelationship(securityContext,parentNode,nodeToAdd,relProperties);
            logger.log(Level.INFO,"Created new relationship between parent node {0}, added node {1} ({2})",new Object[]{parentNode.getUuid(),nodeToAdd.getUuid(),relData});
          }
          if ((originalPageId != null) && (newPageId != null) && !originalPageId.equals(newPageId)) {
            logger.log(Level.INFO,"Tagging branch of added node {0}: originalPageId: {1}, newPageId: {2}",new Object[]{nodeToAdd.getUuid(),originalPageId,newPageId});
            RelationshipHelper.tagOutgoingRelsWithPageId(nodeToAdd,nodeToAdd,originalPageId,newPageId);
          }
        }
 catch (        Throwable t) {
          t.printStackTrace();
          getWebSocket().send(MessageBuilder.status().code(400).message(t.getMessage()).build(),true);
        }
      }
      if (childContent != null) {
        Content contentNode=null;
        final List<NodeAttribute> attrs=new LinkedList<NodeAttribute>();
        attrs.add(new NodeAttribute(Content.content,childContent));
        attrs.add(new NodeAttribute(Content.contentType,"text/plain"));
        attrs.add(new NodeAttribute(AbstractNode.type,Content.class.getSimpleName()));
        StructrTransaction transaction=new StructrTransaction(){
          @Override public Object execute() throws FrameworkException {
            return Services.command(securityContext,CreateNodeCommand.class).execute(attrs);
          }
        }
;
        try {
          contentNode=(Content)Services.command(securityContext,TransactionCommand.class).execute(transaction);
        }
 catch (        FrameworkException fex) {
          logger.log(Level.WARNING,"Could not create content child node.",fex);
          getWebSocket().send(MessageBuilder.status().code(fex.getStatus()).message(fex.getMessage()).build(),true);
        }
        if (contentNode != null) {
          try {
            relData.put(newPageId,0L);
            PropertyMap relProperties=PropertyMap.inputTypeToJavaType(securityContext,relData);
            HtmlElement.children.createRelationship(securityContext,nodeToAdd,contentNode,relProperties);
            if ((originalPageId != null) && (newPageId != null) && !originalPageId.equals(newPageId)) {
              RelationshipHelper.tagOutgoingRelsWithPageId(contentNode,contentNode,originalPageId,newPageId);
            }
          }
 catch (          Throwable t) {
            getWebSocket().send(MessageBuilder.status().code(400).message(t.getMessage()).build(),true);
          }
        }
      }
    }
 else {
      getWebSocket().send(MessageBuilder.status().code(404).build(),true);
    }
  }
 else {
    getWebSocket().send(MessageBuilder.status().code(400).message("Add needs id and data.id!").build(),true);
  }
}
