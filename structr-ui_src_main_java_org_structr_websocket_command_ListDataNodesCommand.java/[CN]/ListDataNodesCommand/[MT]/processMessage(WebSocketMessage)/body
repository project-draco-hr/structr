{
  final SecurityContext securityContext=getWebSocket().getSecurityContext();
  String rawType=(String)webSocketData.getNodeData().get("type");
  String key=(String)webSocketData.getNodeData().get("key");
  Class type=EntityContext.getEntityClassForRawType(rawType);
  List<SearchAttribute> searchAttributes=new LinkedList<SearchAttribute>();
  Set<String> nodesWithChildren=new HashSet();
  searchAttributes.add(Search.andExactType(type.getSimpleName()));
  final String sortOrder=webSocketData.getSortOrder();
  final String sortKey=webSocketData.getSortKey();
  final int pageSize=webSocketData.getPageSize();
  final int page=webSocketData.getPage();
  PropertyKey sortProperty=EntityContext.getPropertyKeyForJSONName(type,sortKey);
  try {
    Result result=(Result)Services.command(securityContext,SearchNodeCommand.class).execute(true,false,searchAttributes,sortProperty,"desc".equals(sortOrder));
    List<AbstractNode> filteredResults=new LinkedList<AbstractNode>();
    List<? extends DataNode> resultList=result.getResults();
    for (    DataNode dataNode : resultList) {
      if (dataNode.getParent(key) == null) {
        filteredResults.add(dataNode);
        if (dataNode.hasChildren(key)) {
          nodesWithChildren.add(dataNode.getUuid());
        }
      }
    }
    int resultCountBeforePaging=filteredResults.size();
    webSocketData.setResult(PagingHelper.subList(filteredResults,pageSize,page,null));
    webSocketData.setRawResultCount(resultCountBeforePaging);
    webSocketData.setNodesWithChildren(nodesWithChildren);
    getWebSocket().send(webSocketData,true);
  }
 catch (  FrameworkException fex) {
    fex.printStackTrace();
  }
}
