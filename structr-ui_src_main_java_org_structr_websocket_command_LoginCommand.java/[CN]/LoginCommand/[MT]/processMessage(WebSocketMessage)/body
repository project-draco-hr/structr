{
  final String username=(String)webSocketData.getNodeData().get("username");
  final String password=(String)webSocketData.getNodeData().get("password");
  Principal user=null;
  if ((username != null) && (password != null)) {
    try {
      StructrWebSocket socket=this.getWebSocket();
      Authenticator auth=socket.getAuthenticator();
      user=auth.doLogin(socket.getRequest(),username,password);
      if (user != null) {
        final String sessionId=webSocketData.getSessionId();
        if (sessionId == null) {
          logger.log(Level.INFO,"Could not login {0}: No sessionId found",new Object[]{username,password});
          getWebSocket().send(MessageBuilder.status().code(403).build(),true);
        }
        final Principal principal=user;
        principal.setProperty(Principal.sessionId,sessionId);
        webSocketData.getNodeData().clear();
        webSocketData.setToken(sessionId);
        webSocketData.getNodeData().put("username",user.getProperty(AbstractNode.name));
        this.getWebSocket().setAuthenticated(sessionId,user);
        this.getWebSocket().send(webSocketData,false);
      }
    }
 catch (    AuthenticationException e) {
      logger.log(Level.INFO,"Could not login {0} with {1}",new Object[]{username,password});
      getWebSocket().send(MessageBuilder.status().code(403).build(),true);
    }
catch (    FrameworkException fex) {
      logger.log(Level.WARNING,"Unable to execute command",fex);
    }
  }
}
