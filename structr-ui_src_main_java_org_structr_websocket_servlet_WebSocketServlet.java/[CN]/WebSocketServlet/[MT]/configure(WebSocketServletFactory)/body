{
  final GsonBuilder gsonBuilderWithDepth1=new GsonBuilder().setPrettyPrinting().registerTypeAdapter(WebSocketMessage.class,new WebSocketDataGSONAdapter(config.getDefaultIdProperty(),1));
  final GsonBuilder gsonBuilderWithDepth2=new GsonBuilder().setPrettyPrinting().registerTypeAdapter(WebSocketMessage.class,new WebSocketDataGSONAdapter(config.getDefaultIdProperty(),2));
  final boolean lenient=Boolean.parseBoolean(StructrApp.getConfigurationValue("json.lenient","false"));
  if (lenient) {
    gsonBuilderWithDepth2.serializeSpecialFloatingPointValues();
  }
  final SynchronizationController syncController=new SynchronizationController(gsonBuilderWithDepth1.create());
  TransactionCommand.registerTransactionListener(syncController);
  factory.getPolicy().setIdleTimeout(61000);
  factory.setCreator(new StructrWebSocketCreator(syncController,gsonBuilderWithDepth2.create(),config.getDefaultIdProperty(),config.getAuthenticator()));
  factory.register(StructrWebSocket.class);
  factory.getExtensionFactory().unregister("x-webkit-deflate-frame");
  factory.getExtensionFactory().unregister("permessage-deflate");
  factory.getPolicy().setMaxTextMessageSize(MAX_TEXT_MESSAGE_SIZE);
}
