{
  if (reportForm.isValid()) {
    Command search=Services.createCommand(SearchNodeCommand.class);
    reportResults=(List<StructrNode>)search.execute(null,user,true,false,searchAttributes);
    populateReportResultsTable();
    saveState();
  }
  List<String[]> resultList=new ArrayList<String[]>();
  List<String> keys=new ArrayList<String>();
  for (  Column c : columns) {
    keys.add(c.getName());
  }
  resultList.add((keys.toArray(new String[keys.size()])));
  if (reportResults == null) {
    return false;
  }
  for (  StructrNode s : reportResults) {
    List<String> values=new ArrayList<String>();
    for (    Column c : columns) {
      Object value=s.getProperty(c.getName());
      if (value != null) {
        values.add(value.toString());
      }
    }
    String[] sa=values.toArray(new String[values.size()]);
    resultList.add(sa);
  }
  File reportFile=new File("/tmp/report.csv");
  CSVWriter csvw=null;
  try {
    char sepChar;
    char quoteChar;
    char escChar;
    String sepFieldValue=reportForm.getFieldValue(CSV_SEPARATOR_CHAR);
    String quoteFieldValue=reportForm.getFieldValue(CSV_QUOTE_CHAR);
    String escFieldValue=reportForm.getFieldValue(CSV_ESCAPE_CHAR);
    if (sepFieldValue != null && !(sepFieldValue.isEmpty())) {
      sepChar=sepFieldValue.charAt(0);
      if (quoteFieldValue != null && !(quoteFieldValue.isEmpty())) {
        quoteChar=quoteFieldValue.charAt(0);
        if (escFieldValue != null && !(escFieldValue.isEmpty())) {
          escChar=escFieldValue.charAt(0);
          csvw=new CSVWriter(new FileWriter(reportFile),sepChar,quoteChar,escChar);
        }
 else {
          csvw=new CSVWriter(new FileWriter(reportFile),sepChar,quoteChar);
        }
      }
 else {
        csvw=new CSVWriter(new FileWriter(reportFile),sepChar);
      }
    }
    csvw.writeAll(resultList);
    csvw.flush();
    csvw.close();
  }
 catch (  IOException ex) {
    Logger.getLogger(Report.class.getName()).log(Level.SEVERE,null,ex);
  }
 finally {
    if (csvw != null) {
      try {
        csvw.close();
      }
 catch (      IOException ignore) {
      }
    }
  }
  return false;
}
