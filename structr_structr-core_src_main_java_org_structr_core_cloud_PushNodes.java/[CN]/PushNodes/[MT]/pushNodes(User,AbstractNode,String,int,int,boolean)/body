{
  List<DataContainer> transportSet=new LinkedList<DataContainer>();
  Set<RelationshipDataContainer> transportRelationships=new HashSet<RelationshipDataContainer>();
  int chunkSize=65536;
  int maxSize=4096;
  if (recursive) {
    List<AbstractNode> nodes=node.getAllChildren();
    for (    AbstractNode n : nodes) {
      if (n instanceof File) {
        File file=(File)n;
        FileNodeDataContainer container=new FileNodeDataContainer(file);
        transportSet.add(container);
        maxSize=Math.max(maxSize,container.getEstimatedSize());
        for (        FileChunkContainer chunk : FileNodeDataContainer.getChunks(file,chunkSize)) {
          maxSize=Math.max(maxSize,chunk.getEstimatedSize());
          transportSet.add(chunk);
        }
      }
 else {
        DataContainer container=new NodeDataContainer(n);
        transportSet.add(container);
        maxSize=Math.max(maxSize,container.getEstimatedSize());
      }
      List<StructrRelationship> rels=n.getOutgoingRelationships();
      for (      StructrRelationship r : rels) {
        AbstractNode startNode=r.getStartNode();
        AbstractNode endNode=r.getEndNode();
        if (nodes.contains(startNode) && nodes.contains(endNode)) {
          transportRelationships.add(new RelationshipDataContainer(r));
        }
      }
    }
    transportSet.addAll(transportRelationships);
  }
 else {
    if (node instanceof File) {
      File file=(File)node;
      FileNodeDataContainer container=new FileNodeDataContainer(file);
      transportSet.add(container);
      maxSize=Math.max(maxSize,container.getEstimatedSize());
      for (      FileChunkContainer chunk : FileNodeDataContainer.getChunks(file,chunkSize)) {
        maxSize=Math.max(maxSize,chunk.getEstimatedSize());
        transportSet.add(chunk);
      }
    }
 else {
      transportSet.add(new NodeDataContainer(node));
    }
  }
  Log.set(Log.LEVEL_DEBUG);
  Client client=new Client(maxSize * 8,maxSize * 2);
  client.start();
  logger.log(Level.INFO,"KryoNet client started, buffer sizes {0}, {1}",new Object[]{maxSize * 8,maxSize * 2});
  Kryo kryo=client.getKryo();
  CloudService.registerClasses(kryo);
  try {
    client.connect(5000,remoteHost,remoteTcpPort,remoteUdpPort);
    logger.log(Level.INFO,"Connected to structr instance on {0} (tcp port: {1}, udp port: {2})",new Object[]{remoteHost,remoteTcpPort,remoteUdpPort});
    client.sendTCP(CloudService.BEGIN_TRANSACTION);
    for (    DataContainer container : transportSet) {
      client.sendTCP(container);
      try {
        Thread.sleep(client.getReturnTripTime());
      }
 catch (      Throwable t) {
      }
    }
    client.sendTCP(CloudService.END_TRANSACTION);
    logger.log(Level.INFO,"Transport set with {0} nodes/relationships was sent",transportSet.size());
  }
 catch (  IOException ex) {
    logger.log(Level.SEVERE,"Error while sending nodes to remote instance",ex);
  }
}
