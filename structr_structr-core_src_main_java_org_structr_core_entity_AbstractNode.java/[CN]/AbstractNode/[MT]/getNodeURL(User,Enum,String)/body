{
  String domain="";
  String site="";
  String path="";
  if (RenderMode.PUBLIC.equals(renderMode)) {
    Command nodeFactory=Services.command(NodeFactoryCommand.class);
    AbstractNode node=(AbstractNode)nodeFactory.execute(this);
    while (node != null && node.getId() > 0) {
      String urlPart=node.getUrlPart();
      if (urlPart != null) {
        if (urlPart.startsWith("http://")) {
          site=urlPart;
        }
 else         if (urlPart.endsWith("/")) {
          domain=urlPart;
        }
 else {
          path=node.getUrlPart() + (!("".equals(path)) ? "/" + path : "");
        }
      }
      node=node.getParentNode(user);
    }
    return site + (site != null ? "." : "") + domain+ path;
  }
 else   if (RenderMode.LOCAL.equals(renderMode)) {
    String localUrl=contextPath.concat(getNodePath(user)).concat("&renderMode=local");
    return localUrl;
  }
 else {
    return null;
  }
}
