{
  Configuration cfg=new Configuration();
  try {
    AbstractNode callingNode=null;
    if (getTemplate() != null) {
      callingNode=template.getCallingNode();
      Map root=new HashMap();
      root.put("this",this);
      if (callingNode != null) {
        root.put(callingNode.getType(),callingNode);
      }
      HttpServletRequest request=CurrentRequest.getRequest();
      if (request != null) {
        root.put("Request",new freemarker.ext.servlet.HttpRequestParametersHashModel(request));
        String searchString=request.getParameter("search");
        if (searchString != null && !(searchString.isEmpty())) {
          Command search=Services.command(SearchNodeCommand.class);
          List<AbstractNode> result=(List<AbstractNode>)search.execute(null,null,false,true,Search.orName(searchString));
          root.put("SearchResults",result);
        }
      }
      if (user != null) {
        root.put("User",user);
      }
      root.put("Helper",new TemplateHelper());
      HttpSession session=CurrentRequest.getSession();
      if (session != null) {
        if (session.getAttribute("errorMessage") != null) {
          root.put("ErrorMessage",session.getAttribute("errorMessage"));
        }
        if (session.getAttribute("errorMessage") != null) {
          root.put("OkMessage",session.getAttribute("okMessage"));
        }
      }
      freemarker.template.Template t=new freemarker.template.Template(template.getName(),new StringReader(templateString),cfg);
      t.process(root,out);
    }
 else {
      out.write(templateString);
      out.flush();
    }
  }
 catch (  Throwable t) {
    logger.log(Level.WARNING,"Error: {0}",t.getMessage());
  }
}
