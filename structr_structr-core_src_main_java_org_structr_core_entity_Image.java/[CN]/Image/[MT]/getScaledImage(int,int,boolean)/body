{
  thumbnailRelationships=getThumbnailRelationships();
  Image thumbnail=null;
  final Image originalImage=this;
  Integer origWidth=originalImage.getWidth();
  Integer origHeight=originalImage.getHeight();
  if ((origWidth != null) && (origHeight != null)) {
    if ((thumbnailRelationships != null) && !(thumbnailRelationships.isEmpty())) {
      for (      StructrRelationship r : thumbnailRelationships) {
        Integer w=(Integer)r.getProperty(Key.width.name());
        Integer h=(Integer)r.getProperty(Key.height.name());
        if ((w != null) && (h != null)) {
          if (((w == maxWidth) && (h <= maxHeight)) || ((w <= maxWidth) && (h == maxHeight)) || ((origWidth <= w) && (origHeight <= h))) {
            thumbnail=(Image)r.getEndNode();
            if (!(originalImage.getLastModifiedDate().after(thumbnail.getLastModifiedDate()))) {
              return thumbnail;
            }
          }
        }
      }
    }
  }
  logger.log(Level.INFO,"Creating thumbnail for {0}",getName());
  Command transactionCommand=Services.command(securityContext,TransactionCommand.class);
  thumbnail=(Image)transactionCommand.execute(new StructrTransaction(){
    @Override public Object execute() throws Throwable {
      Command createNode=Services.command(securityContext,CreateNodeCommand.class);
      Command createRel=Services.command(securityContext,CreateRelationshipCommand.class);
      NodeAttribute typeAttr=new NodeAttribute(AbstractNode.Key.type.name(),Image.class.getSimpleName());
      NodeAttribute contentTypeAttr=new NodeAttribute(File.Key.contentType.name(),"image/" + Thumbnail.FORMAT);
      NodeAttribute isHiddenAttr=new NodeAttribute(AbstractNode.Key.hidden.name(),originalImage.getHidden());
      NodeAttribute isPublicAttr=new NodeAttribute(AbstractNode.Key.visibleToPublicUsers.name(),originalImage.getVisibleToPublicUsers());
      NodeAttribute isVisibleForAuthenticatedUsersAttr=new NodeAttribute(AbstractNode.Key.visibleToAuthenticatedUsers.name(),originalImage.getVisibleToAuthenticatedUsers());
      Thumbnail thumbnailData=ImageHelper.createThumbnail(originalImage,maxWidth,maxHeight,cropToFit);
      if (thumbnailData != null) {
        Image thumbnail=(Image)createNode.execute(originalImage.getOwnerNode(),typeAttr,contentTypeAttr,isHiddenAttr,isPublicAttr,isVisibleForAuthenticatedUsersAttr,false);
        if (thumbnail != null) {
          StructrRelationship thumbnailRelationship=(StructrRelationship)createRel.execute(originalImage,thumbnail,RelType.THUMBNAIL);
          thumbnailRelationships.add(thumbnailRelationship);
          String relativeFilePath=thumbnail.getId() + "_" + System.currentTimeMillis();
          String path=Services.getFilesPath() + "/" + relativeFilePath;
          java.io.File imageFile=new java.io.File(path);
          try {
            FileUtils.writeByteArrayToFile(imageFile,thumbnailData.getBytes());
          }
 catch (          IOException ex) {
            logger.log(Level.SEVERE,"Could not write thumbnail data to file",ex);
            return null;
          }
          long size=imageFile.length();
          thumbnail.setSize(size);
          Integer tnWidth=thumbnailData.getWidth();
          Integer tnHeight=thumbnailData.getHeight();
          thumbnailRelationship.setProperty(Key.width.name(),tnWidth);
          thumbnailRelationship.setProperty(Key.height.name(),tnHeight);
          thumbnail.setRelativeFilePath(relativeFilePath);
          thumbnail.setName(originalImage.getName() + "_thumb_" + tnWidth+ "x"+ tnHeight);
        }
        return thumbnail;
      }
 else {
        logger.log(Level.WARNING,"Could not create thumbnail for image {0} ({1})",new Object[]{getName(),getId()});
        return null;
      }
    }
  }
);
  return thumbnail;
}
