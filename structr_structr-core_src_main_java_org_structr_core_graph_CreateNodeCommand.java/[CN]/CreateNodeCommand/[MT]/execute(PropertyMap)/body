{
  GraphDatabaseService graphDb=(GraphDatabaseService)arguments.get("graphDb");
  Principal user=securityContext.getUser();
  T node=null;
  if (graphDb != null) {
    CreateRelationshipCommand createRel=Services.command(securityContext,CreateRelationshipCommand.class);
    Date now=new Date();
    PropertyMap properties=new PropertyMap(attributes);
    Object typeObject=properties.get(AbstractNode.type);
    String nodeType=(typeObject != null) ? typeObject.toString() : EntityContext.getGenericFactory().createGenericNode().getClass().getSimpleName();
    NodeFactory<T> nodeFactory=new NodeFactory<T>(SecurityContext.getSuperUserInstance());
    node=nodeFactory.createNodeWithType(graphDb.createNode(),nodeType);
    if (node != null) {
      if ((user != null) && user instanceof AbstractNode) {
        AbstractNode owner=(AbstractNode)user;
        createRel.execute(owner,node,RelType.OWNS,false);
        AbstractRelationship securityRel=createRel.execute(owner,node,RelType.SECURITY,false);
        securityRel.setAllowed(Permission.values());
        node.unlockReadOnlyPropertiesOnce();
        node.setProperty(AbstractNode.createdBy,user.getProperty(AbstractNode.uuid),false);
      }
      node.unlockReadOnlyPropertiesOnce();
      node.setProperty(AbstractNode.createdDate,now,false);
      node.unlockReadOnlyPropertiesOnce();
      node.setProperty(AbstractNode.lastModifiedDate,now,false);
      logger.log(Level.FINE,"Node {0} created",node.getId());
      properties.remove(AbstractNode.type);
      for (      Entry<PropertyKey,Object> attr : properties.entrySet()) {
        Object value=attr.getValue();
        node.setProperty(attr.getKey(),value);
      }
      properties.clear();
    }
  }
  if (node != null) {
    node.onNodeCreation();
    for (    Transformation<GraphObject> transformation : EntityContext.getEntityCreationTransformations(node.getClass())) {
      transformation.apply(securityContext,node);
    }
  }
  return node;
}
