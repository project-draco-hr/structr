{
  GraphDatabaseService graphDb=(GraphDatabaseService)arguments.get("graphDb");
  Long transactionKey=transactionKeys.get();
  Transaction tx=transactions.get();
  Throwable exception=null;
  T ret=null;
  if (tx == null || transactionKey == null) {
    tx=graphDb.beginTx();
    transactionKey=nextLong();
    transactionKeys.set(transactionKey);
    transactions.set(tx);
    EntityContext.setSecurityContext(securityContext);
    EntityContext.setTransactionKey(transactionKey);
    try {
      ret=transaction.execute();
      tx.success();
    }
 catch (    Throwable t) {
      if (debug) {
        t.printStackTrace();
      }
      tx.failure();
      exception=t;
    }
 finally {
      transactions.remove();
      transactionKeys.remove();
synchronized (TransactionCommand.class) {
        try {
          tx.finish();
        }
 catch (        Throwable t) {
          if (debug) {
            t.printStackTrace();
          }
          exception=EntityContext.getFrameworkException(transactionKey);
        }
      }
    }
    if (exception != null) {
      if (debug) {
        exception.printStackTrace();
      }
      if (exception instanceof FrameworkException) {
        logger.log(Level.WARNING,((FrameworkException)exception).toString());
        EntityContext.clearTransactionData(transactionKey);
        throw (FrameworkException)exception;
      }
    }
    final TransactionChangeSet changeSet=EntityContext.getTransactionChangeSet(transactionKey);
    Long depthValue=depths.get();
    long depth=0;
    if (depthValue != null) {
      depth=depthValue.longValue();
    }
    if (debug) {
      indent();
      System.out.println("BEFORE CHANGESET: " + transactionKey);
    }
    if (changeSet != null) {
      if (debug) {
        indent();
        System.out.println("BEFORE DEPTH: " + depth);
      }
      if (depth < MAX_DEPTH && !changeSet.systemOnly()) {
        if (debug) {
          indent();
          System.out.println("AFTER DEPTH: " + depth);
        }
        depths.set(depth + 1);
        try {
          Services.command(securityContext,TransactionCommand.class).execute(new StructrTransaction(){
            @Override public Object execute() throws FrameworkException {
              notifyChangeSet(changeSet);
              return null;
            }
          }
);
        }
 catch (        Throwable t) {
          if (debug) {
            t.printStackTrace();
          }
          if (t instanceof FrameworkException) {
            logger.log(Level.WARNING,((FrameworkException)t).toString());
            EntityContext.clearTransactionData(transactionKey);
            throw (FrameworkException)t;
          }
        }
        depths.set(depth);
      }
 else {
        if (depth == MAX_DEPTH) {
          logger.log(Level.SEVERE,"Maximum depth of nested modifications reached! You probably forgot to mark a property as a system property.");
        }
        if (debug) {
          indent();
          System.out.println("CHANGESET STATS: " + changeSet.toString());
        }
      }
    }
    EntityContext.clearTransactionData(transactionKey);
    return ret;
  }
 else {
    if (debug) {
      indent();
      System.out.println("EXISTING TRANSACTION: " + transactionKey);
    }
    return transaction.execute();
  }
}
