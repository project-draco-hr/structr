{
  final GraphDatabaseService graphDb=(GraphDatabaseService)arguments.get("graphDb");
  final SecurityContext superUserContext=SecurityContext.getSuperUserInstance();
  final NodeFactory nodeFactory=new NodeFactory(superUserContext);
  final SearchNodeCommand searchNode=Services.command(superUserContext,SearchNodeCommand.class);
  if (graphDb != null) {
    Services.command(securityContext,TransactionCommand.class).execute(new BatchTransaction(){
      @Override public Object execute(      Transaction tx) throws FrameworkException {
        Result<AbstractNode> result=null;
        long n=0L;
        if (properties.containsKey(AbstractNode.type.name())) {
          List<SearchAttribute> attrs=new LinkedList<SearchAttribute>();
          attrs.add(Search.andExactType((String)properties.get(AbstractNode.type.name())));
          result=searchNode.execute(attrs);
          properties.remove(AbstractNode.type.name());
        }
 else {
          result=nodeFactory.createAllNodes(GlobalGraphOperations.at(graphDb).getAllNodes());
        }
        for (        AbstractNode node : result.getResults()) {
          if (node.getProperty(AbstractNode.uuid) != null) {
            for (            Entry entry : properties.entrySet()) {
              String key=(String)entry.getKey();
              Object val=entry.getValue();
              node.unlockReadOnlyPropertiesOnce();
              node.setProperty(new Property(key),val);
            }
            if (n > 1000 && n % 1000 == 0) {
              logger.log(Level.INFO,"Set properties on {0} nodes, committing results to database.",n);
              tx.success();
              tx.finish();
              tx=graphDb.beginTx();
              logger.log(Level.FINE,"######## committed ########",n);
            }
            n++;
          }
        }
        logger.log(Level.INFO,"Finished setting properties on {0} nodes",n);
        return null;
      }
    }
);
  }
}
