{
  final GraphDatabaseService graphDb=(GraphDatabaseService)arguments.get("graphDb");
  final RelationshipFactory relationshipFactory=(RelationshipFactory)arguments.get("relationshipFactory");
  final Command searchRel=Services.command(SecurityContext.getSuperUserInstance(),SearchRelationshipCommand.class);
  if (!((parameters != null) && (parameters.length == 1) && (parameters[0] instanceof Map)&& !((Map)parameters[0]).isEmpty())) {
    throw new IllegalArgumentException("This command requires one argument of type Map. Map must not be empty.");
  }
  final Map<String,Object> properties=(Map<String,Object>)parameters[0];
  if (graphDb != null) {
    final Command transactionCommand=Services.command(securityContext,TransactionCommand.class);
    transactionCommand.execute(new BatchTransaction(){
      @Override public Object execute(      Transaction tx) throws FrameworkException {
        long n=0L;
        List<AbstractRelationship> rels=null;
        if (properties.containsKey(AbstractRelationship.combinedType.name())) {
          List<SearchAttribute> attrs=new LinkedList<SearchAttribute>();
          attrs.add(Search.andExactType((String)properties.get(AbstractRelationship.combinedType.name())));
          rels=(List<AbstractRelationship>)searchRel.execute(attrs);
          properties.remove(AbstractRelationship.combinedType.name());
        }
 else {
          rels=(List<AbstractRelationship>)relationshipFactory.createRelationships(securityContext,GlobalGraphOperations.at(graphDb).getAllRelationships());
        }
        for (        AbstractRelationship rel : rels) {
          if (rel.getStringProperty(AbstractRelationship.uuid) != null) {
            for (            Entry entry : properties.entrySet()) {
              String key=(String)entry.getKey();
              Object val=entry.getValue();
              rel.setProperty(new Property(key),val);
            }
            if (n > 1000 && n % 1000 == 0) {
              logger.log(Level.INFO,"Set properties on {0} relationships, committing results to database.",n);
              tx.success();
              tx.finish();
              tx=graphDb.beginTx();
              logger.log(Level.FINE,"######## committed ########",n);
            }
            n++;
          }
        }
        logger.log(Level.INFO,"Finished setting properties on {0} relationships",n);
        return null;
      }
    }
);
  }
  return null;
}
