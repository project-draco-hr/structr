{
  AbstractNode p=(AbstractNode)parentNode.getValue();
  if (!(p instanceof Link)) {
    List<AbstractNode> nodes=new LinkedList<AbstractNode>();
    Command nodeFactory=Services.command(NodeFactoryCommand.class);
    List<StructrRelationship> rels=nodeToAdd.getOutgoingChildRelationships();
    if (rels.size() > 1000) {
      logger.log(Level.WARNING,"Node has many relationships: {0}",rels.size());
    }
    int counter=0;
    for (    StructrRelationship r : rels) {
      AbstractNode subNode=r.getEndNode();
      if (isSuperUser || (subNode.readAllowed())) {
        logger.log(Level.INFO,"isSuperUser? {0}, readAllowed? {1}",new Object[]{isSuperUser,subNode.readAllowed()});
        AbstractNode s=(AbstractNode)nodeFactory.execute(subNode);
        nodes.add(s);
      }
      counter++;
      if (counter > 1000) {
        logger.log(Level.SEVERE,"This node has too many relationships, displaying only the first 1000");
        break;
      }
    }
    nodeFactory=Services.command(LinkNodeFactoryCommand.class);
    rels=nodeToAdd.getOutgoingLinkRelationships();
    for (    StructrRelationship r : rels) {
      AbstractNode subNode=r.getEndNode();
      if (isSuperUser || (subNode.readAllowed())) {
        AbstractNode s=(AbstractNode)nodeFactory.execute(subNode);
        nodes.add(s);
      }
    }
    if (!(nodes.isEmpty())) {
      Collections.sort(nodes,new Comparator<AbstractNode>(){
        @Override public int compare(        AbstractNode nodeOne,        AbstractNode nodeTwo){
          return nodeOne.getPosition().compareTo(nodeTwo.getPosition());
        }
      }
);
      for (      AbstractNode s : nodes) {
        TreeNode newNode=addTreeNode(s,parentNode);
        List<TreeNode> expandedNodes=nodeTree.getExpandedNodes(true);
        if (openNodes.contains(newNode) || expandedNodes.contains(newNode)) {
          nodeTree.expand(newNode);
          addItems(newNode,s);
        }
 else {
          if (s.hasChildren()) {
            DummyNode dummyNode=new DummyNode();
            addTreeNode(dummyNode,newNode);
          }
        }
        newNode.setChildrenSupported(true);
      }
    }
  }
}
