{
  AbstractNode s=null;
  if (uploadForm.isValid()) {
    List<Field> fieldList=(List<Field>)uploadForm.getFieldList();
    for (    Field f : fieldList) {
      if (!(f instanceof FileField)) {
        break;
      }
      final FileField fileField=(FileField)f;
      final FileItem fileFromUpload=fileField.getFileItem();
      final String name=fileFromUpload.getName();
      final String mimeType=fileFromUpload.getContentType();
      final User user=securityContext.getUser();
      if (name != null && !("".equals(name))) {
        Command transaction=Services.command(TransactionCommand.class);
        s=(AbstractNode)transaction.execute(new StructrTransaction(){
          @Override public Object execute() throws Throwable {
            Command createNode=Services.command(CreateNodeCommand.class);
            Command createRel=Services.command(CreateRelationshipCommand.class);
            String mimeProperty=null;
            if (mimeType != null && mimeType.startsWith("image")) {
              mimeProperty="Image";
            }
 else {
              mimeProperty="File";
            }
            AbstractNode newNode=(AbstractNode)createNode.execute(new NodeAttribute(AbstractNode.Key.type.name(),mimeProperty),user);
            String relativeFilePath=newNode.getId() + "_" + System.currentTimeMillis();
            String path=FILES_PATH + "/" + relativeFilePath;
            long size=fileFromUpload.getSize();
            java.io.File fileOnDisk=new java.io.File(path);
            String fileUrl="file:///" + fileOnDisk.getPath();
            try {
              fileFromUpload.write(fileOnDisk);
            }
 catch (            Exception e) {
              okMsg="";
              errorMsg="Error while write uploaded file(s) to disk: " + e.getStackTrace();
            }
            Date now=new Date();
            newNode.setProperty(AbstractNode.Key.name.name(),name);
            newNode.setProperty(AbstractNode.Key.createdDate.name(),now);
            newNode.setProperty(AbstractNode.Key.lastModifiedDate.name(),now);
            newNode.setProperty(File.Key.contentType.name(),mimeType);
            newNode.setProperty(File.Key.size.name(),String.valueOf(size));
            newNode.setProperty(File.Key.url.name(),fileUrl);
            newNode.setProperty(File.Key.relativeFilePath.name(),relativeFilePath);
            AbstractNode parentNode=node;
            createRel.execute(parentNode,newNode,RelType.HAS_CHILD);
            newNodeForm.clearValues();
            addTreeNode(newNode,getCurrentTreeNode());
            return (newNode);
          }
        }
);
      }
 else {
        warnMsg="No file was selected.";
      }
    }
    okMsg="New " + s.getType() + " node "+ s.getName()+ " has been created.";
    Services.command(AddNotificationCommand.class).execute(new SuccessNotification(securityContext,okMsg));
    Map<String,String> parameters=new HashMap<String,String>();
    parameters.put(NODE_ID_KEY,String.valueOf(getNodeId()));
    parameters.put(RENDER_MODE_KEY,renderMode);
    parameters.put(OK_MSG_KEY,okMsg);
    setRedirect(getRedirectPage(node),parameters);
  }
  if (!uploadForm.isValid()) {
    uploadFormIsInvalid="true";
    return true;
  }
  return false;
}
