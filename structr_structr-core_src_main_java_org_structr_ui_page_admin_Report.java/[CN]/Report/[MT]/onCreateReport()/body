{
  onPreviewReport();
  final String reportFileName=reportName.getValue() + ".csv";
  Map methodCache=new HashMap<Object,Object>();
  List<String[]> resultList=new LinkedList<String[]>();
  List<String> keys=new LinkedList<String>();
  for (  Column c : columns) {
    keys.add(c.getName());
  }
  resultList.add((keys.toArray(new String[keys.size()])));
  if (reportResults == null) {
    return false;
  }
  for (  AbstractNode s : reportResults) {
    List<String> values=new LinkedList<String>();
    for (    Column c : columns) {
      try {
        Object value=PropertyUtils.getValue(s,c.getName(),methodCache);
        if (value != null) {
          values.add(value.toString());
        }
 else {
          values.add("");
        }
      }
 catch (      RuntimeException re) {
        continue;
      }
    }
    String[] sa=values.toArray(new String[values.size()]);
    resultList.add(sa);
  }
  final File reportFile=new File("/tmp/" + reportFileName);
  CSVWriter csvw=null;
  try {
    char sepChar;
    char quoteChar;
    char escChar;
    String sepFieldValue=reportForm.getFieldValue(CSV_SEPARATOR_CHAR);
    String quoteFieldValue=reportForm.getFieldValue(CSV_QUOTE_CHAR);
    String escFieldValue=reportForm.getFieldValue(CSV_ESCAPE_CHAR);
    if (sepFieldValue != null && !(sepFieldValue.isEmpty())) {
      sepChar=sepFieldValue.charAt(0);
      if (quoteFieldValue != null && !(quoteFieldValue.isEmpty())) {
        quoteChar=quoteFieldValue.charAt(0);
        if (escFieldValue != null && !(escFieldValue.isEmpty())) {
          escChar=escFieldValue.charAt(0);
          csvw=new CSVWriter(new FileWriter(reportFile),sepChar,quoteChar,escChar);
        }
 else {
          csvw=new CSVWriter(new FileWriter(reportFile),sepChar,quoteChar);
        }
      }
 else {
        csvw=new CSVWriter(new FileWriter(reportFile),sepChar);
      }
    }
    csvw.writeAll(resultList);
    csvw.flush();
    csvw.close();
    AbstractNode s=null;
    Command transaction=Services.command(TransactionCommand.class);
    s=(AbstractNode)transaction.execute(new StructrTransaction(){
      @Override public Object execute() throws Throwable {
        Command createNode=Services.command(CreateNodeCommand.class);
        Command createRel=Services.command(CreateRelationshipCommand.class);
        AbstractNode newNode=(AbstractNode)createNode.execute(new NodeAttribute(AbstractNode.Key.type.name(),File.class.getSimpleName()),user);
        String relativeFilePath=newNode.getId() + "_" + System.currentTimeMillis();
        String targetPath=FILES_PATH + "/" + relativeFilePath;
        String fileUrl="file:///" + reportFile.getPath();
        FileUtils.moveFile(reportFile,new File(targetPath));
        Date now=new Date();
        newNode.setProperty(AbstractNode.Key.name.name(),reportFileName);
        newNode.setProperty(AbstractNode.Key.createdDate.name(),now);
        newNode.setProperty(AbstractNode.Key.lastModifiedDate.name(),now);
        newNode.setProperty(org.structr.core.entity.File.Key.contentType.name(),"text/csv");
        newNode.setProperty(org.structr.core.entity.File.Key.size.name(),String.valueOf(reportFile.length()));
        newNode.setProperty(org.structr.core.entity.File.Key.url.name(),fileUrl);
        newNode.setProperty(org.structr.core.entity.File.Key.relativeFilePath.name(),relativeFilePath);
        AbstractNode parentNode=user;
        createRel.execute(parentNode,newNode,RelType.HAS_CHILD);
        return newNode;
      }
    }
);
  }
 catch (  IOException ex) {
    Logger.getLogger(Report.class.getName()).log(Level.SEVERE,null,ex);
  }
 finally {
    if (csvw != null) {
      try {
        csvw.close();
      }
 catch (      IOException ignore) {
      }
    }
  }
  return false;
}
