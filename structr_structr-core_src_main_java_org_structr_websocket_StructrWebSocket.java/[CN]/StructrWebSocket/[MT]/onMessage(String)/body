{
  WebSocketMessage webSocketData=gson.fromJson(data,WebSocketMessage.class);
  try {
    String messageToken=webSocketData.getToken();
    String command=webSocketData.getCommand();
    Class type=commandSet.get(command);
    boolean valid=false;
    if (type != null) {
      if (token.equals(messageToken) || type.equals(LoginCommand.class)) {
        valid=true;
      }
      if (valid) {
        AbstractCommand message=(AbstractCommand)type.newInstance();
        message.setParent(this);
        message.setConnection(connection);
        message.setIdProperty(idProperty);
        message.setToken(token);
        if (message.processMessage(webSocketData)) {
          webSocketData.setToken(null);
          broadcast(gson.toJson(webSocketData,WebSocketMessage.class));
        }
      }
    }
 else {
      logger.log(Level.WARNING,"Unknow command {0}",command);
    }
  }
 catch (  Throwable t) {
    logger.log(Level.WARNING,"Unable to parse message.",t);
  }
}
