{
  try {
    Map<String,String> parsedSource=gson.fromJson(source,new TypeToken<Map<String,String>>(){
    }
.getType());
    String command=parsedSource.get(COMMAND_KEY);
    String id=parsedSource.get(ID_KEY);
    parsedSource.remove(COMMAND_KEY);
    parsedSource.remove(ID_KEY);
    Class type=commandSet.get(command);
    if (type != null) {
      AbstractMessage msg=(AbstractMessage)type.newInstance();
      msg.setParameters(parsedSource);
      msg.setConnection(connection);
      msg.setSource(source);
      msg.setId(id);
      return msg;
    }
 else {
      logger.log(Level.WARNING,"Unknow command {0}",command);
    }
  }
 catch (  Throwable t) {
    logger.log(Level.WARNING,"Unable to parse message.",t);
  }
  return null;
}
