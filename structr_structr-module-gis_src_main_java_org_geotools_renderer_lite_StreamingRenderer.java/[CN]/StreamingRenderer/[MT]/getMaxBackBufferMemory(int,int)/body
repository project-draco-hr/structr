{
  int maxBuffers=0;
  for (  MapLayer layer : context.getLayers()) {
    if (!layer.isVisible()) {
      continue;
    }
    if (layer.getStyle().getFeatureTypeStyles().length < 2) {
      continue;
    }
    int currCount=0;
    FeatureType ftype=layer.getFeatureSource().getSchema();
    for (    FeatureTypeStyle fts : layer.getStyle().getFeatureTypeStyles()) {
      if (isFeatureTypeStyleActive(ftype,fts)) {
        List[] splittedRules=splitRules(fts);
        List ruleList=splittedRules[0];
        List elseRuleList=splittedRules[1];
        if ((ruleList.size() == 0) && (elseRuleList.size() == 0)) {
          continue;
        }
        currCount++;
      }
    }
    currCount--;
    if (currCount > maxBuffers) {
      maxBuffers=currCount;
    }
  }
  return maxBuffers * width * height* 4;
}
