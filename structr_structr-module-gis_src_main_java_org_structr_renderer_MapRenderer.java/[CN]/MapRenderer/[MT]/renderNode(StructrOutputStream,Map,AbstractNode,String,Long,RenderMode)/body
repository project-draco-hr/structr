{
  if ((editNodeId != null) && (currentNode.getId() == editNodeId.longValue())) {
    currentNode.renderEditFrame(out,editUrl);
  }
 else {
    SecurityContext securityContext=out.getSecurityContext();
    if (securityContext.isVisible(currentNode)) {
      if (currentNode.getDontCache() == Boolean.TRUE) {
        long id=startNode.getId();
        ServletContext context=securityContext.getSession().getServletContext();
        java.util.Map<Long,TemporaryValue<String>> mapCache=(java.util.Map<Long,TemporaryValue<String>>)context.getAttribute(MAP_CACHE);
        if (mapCache == null) {
          mapCache=new ConcurrentHashMap<Long,TemporaryValue<String>>(1000,0.9f,8);
          context.setAttribute(MAP_CACHE,mapCache);
        }
        TemporaryValue<String> cachedSVGMap=(TemporaryValue<String>)mapCache.get(id);
        if (cachedSVGMap == null) {
          cachedSVGMap=new TemporaryValue<String>(null,TimeUnit.MINUTES.toMillis(1));
          mapCache.put(id,cachedSVGMap);
        }
        if ((cachedSVGMap.getStoredValue() == null) || cachedSVGMap.isExpired()) {
          StringBuilder content=new StringBuilder(500000);
          renderSVGMap(securityContext,out.getRequest(),currentNode,content,startNode);
          cachedSVGMap.refreshStoredValue(content.toString());
        }
        out.append(cachedSVGMap.getStoredValue());
        return;
      }
      String cachedSVGMap=currentNode.getSvgContent();
      if (StringUtils.isBlank(cachedSVGMap)) {
        StringBuilder cache=new StringBuilder();
        renderSVGMap(securityContext,out.getRequest(),currentNode,cache,startNode);
        currentNode.setSvgContent(cache.toString());
        out.append(cache);
      }
 else {
        out.append(cachedSVGMap);
      }
    }
  }
}
