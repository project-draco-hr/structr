{
  if (editNodeId != null && getId() == editNodeId.longValue()) {
    renderEditFrame(out,editUrl);
  }
 else {
    HttpServletRequest request=CurrentRequest.getRequest();
    if (request == null) {
      return;
    }
    HttpSession session=request.getSession();
    if (session == null) {
      return;
    }
    String usernameFromSession=(String)session.getAttribute(USERNAME_KEY);
    Boolean alreadyLoggedIn=usernameFromSession != null;
    if (alreadyLoggedIn) {
      return;
    }
    Boolean sessionBlocked=(Boolean)session.getAttribute(SESSION_BLOCKED);
    if (Boolean.TRUE.equals(sessionBlocked)) {
      out.append("<div class=\"errorMsg\">").append("Too many login attempts, session is blocked for login").append("</div>");
      return;
    }
    String confirmationKeyFieldName=getConfirmationKeyFieldName() != null ? getConfirmationKeyFieldName() : defaultConfirmationKeyFieldName;
    String confirmationKey=StringUtils.trimToEmpty(request.getParameter(confirmationKeyFieldName));
    if (StringUtils.isNotEmpty(confirmationKey)) {
      return;
    }
    String action=getAction() != null ? getAction() : defaultAction;
    String submitButtonName=getSubmitButtonName() != null ? getSubmitButtonName() : defaultSubmitButtonName;
    String antiRobotFieldName=getAntiRobotFieldName() != null ? getAntiRobotFieldName() : defaultAntiRobotFieldName;
    String usernameFieldName=getUsernameFieldName() != null ? getUsernameFieldName() : defaultUsernameFieldName;
    String passwordFieldName=getPasswordFieldName() != null ? getPasswordFieldName() : defaultPasswordFieldName;
    String firstNameFieldName=getFirstNameFieldName() != null ? getFirstNameFieldName() : defaultFirstNameFieldName;
    String lastNameFieldName=getLastNameFieldName() != null ? getLastNameFieldName() : defaultLastNameFieldName;
    String emailFieldName=getEmailFieldName() != null ? getEmailFieldName() : defaultEmailFieldName;
    String streetFieldName=getStreetFieldName() != null ? getStreetFieldName() : defaultStreetFieldName;
    String zipCodeFieldName=getZipCodeFieldName() != null ? getZipCodeFieldName() : defaultZipCodeFieldName;
    String cityFieldName=getCityFieldName() != null ? getCityFieldName() : defaultCityFieldName;
    String stateFieldName=getStateFieldName() != null ? getStateFieldName() : defaultStateFieldName;
    String countryFieldName=getCountryFieldName() != null ? getCountryFieldName() : defaultCountryFieldName;
    String birthdayFieldName=getBirthdayFieldName() != null ? getBirthdayFieldName() : defaultBirthdayFieldName;
    String genderFieldName=getGenderFieldName() != null ? getGenderFieldName() : defaultGenderFieldName;
    String confirmEmailFieldName=getConfirmEmailFieldName() != null ? getConfirmEmailFieldName() : defaultConfirmEmailFieldName;
    String confirmPasswordFieldName=getConfirmPasswordFieldName() != null ? getConfirmPasswordFieldName() : defaultConfirmPasswordFieldName;
    String cssClass=getCssClass() != null ? getCssClass() : defaultCssClass;
    String label=getLabel() != null ? getLabel() : defaultLabel;
    String agreedToTermsOfUseFieldName=getAgreedToTermsOfUseFieldName() != null ? getAgreedToTermsOfUseFieldName() : defaultAgreedToTermsOfUseFieldName;
    String newsletterFieldName=getNewsletterFieldName() != null ? getNewsletterFieldName() : defaultNewsletterFieldName;
    String username=StringUtils.trimToEmpty(request.getParameter(usernameFieldName));
    String password=StringUtils.trimToEmpty(request.getParameter(passwordFieldName));
    String confirmPassword=StringUtils.trimToEmpty(request.getParameter(confirmPasswordFieldName));
    String firstName=StringUtils.trimToEmpty(request.getParameter(firstNameFieldName));
    String lastName=StringUtils.trimToEmpty(request.getParameter(lastNameFieldName));
    String email=StringUtils.trimToEmpty(request.getParameter(emailFieldName));
    String confirmEmail=StringUtils.trimToEmpty(request.getParameter(confirmEmailFieldName));
    String zipCode=StringUtils.trimToEmpty(request.getParameter(zipCodeFieldName));
    String street=StringUtils.trimToEmpty(request.getParameter(streetFieldName));
    String city=StringUtils.trimToEmpty(request.getParameter(cityFieldName));
    String state=StringUtils.trimToEmpty(request.getParameter(stateFieldName));
    String country=StringUtils.trimToEmpty(request.getParameter(countryFieldName));
    String birthday=StringUtils.trimToEmpty(request.getParameter(birthdayFieldName));
    String gender=StringUtils.trimToEmpty(request.getParameter(genderFieldName));
    String agreedToTermsOfUse=StringUtils.isNotEmpty(request.getParameter(agreedToTermsOfUseFieldName)) ? "checked=\"checked\"" : "";
    String newsletter=StringUtils.isNotEmpty(request.getParameter(newsletterFieldName)) ? "checked=\"checked\"" : "";
    out.append("<form name='").append(getName()).append("' action='").append(action).append("' method='post'>");
    out.append("<input type='hidden' name='").append(antiRobotFieldName).append("' value=''>");
    out.append("<table class='").append(cssClass).append("'>");
    out.append("<tr><td class='label'>Username*</td><td></td></tr>");
    out.append("<tr><td class='field'><input type='text' name='").append(usernameFieldName).append("' value='").append(username).append("' size='30'></td></tr>");
    out.append("<tr><td class='label'>Password*</td><td class='label'>Confirm Password*</td></tr>");
    out.append("<tr>");
    out.append("<td class='field'><input type='password' name='").append(passwordFieldName).append("' value='").append(password).append("' size='30'></td>");
    out.append("<td class='field'><input type='password' name='").append(confirmPasswordFieldName).append("' value='").append(confirmPassword).append("' size='30'></td>");
    out.append("</tr>");
    out.append("<tr><td class='label'>First Name*</td><td class='label'>Last Name*</td></tr>");
    out.append("<tr>");
    out.append("<td class='field'><input type='text' name='").append(firstNameFieldName).append("' value='").append(firstName).append("' size='30'></td>");
    out.append("<td class='field'><input type='text' name='").append(lastNameFieldName).append("' value='").append(lastName).append("' size='30'></td>");
    out.append("</tr>");
    out.append("<tr><td class='label' colspan='2'>Email*</td></tr>");
    out.append("<tr><td class='field twoColumns' colspan='2'><input type='text' name='").append(emailFieldName).append("' value='").append(email).append("' size='60'></td></tr>");
    out.append("<tr><td class='label' colspan='2'>Confirm Email*</td></tr>");
    out.append("<tr><td class='field twoColumns' colspan='2'><input type='text' name='").append(confirmEmailFieldName).append("' value='").append(confirmEmail).append("' size='60'></td></tr>");
    out.append("<tr><td class='label' colspan='2'>Street</td></tr>");
    out.append("<tr><td class='field twoColumns' colspan='2'><input type='text' name='").append(streetFieldName).append("' value='").append(street).append("' size='60'></td></tr>");
    out.append("<tr><td class='label'>ZIP / Postal Code</td><td class='label'>City</td></tr>");
    out.append("<tr>");
    out.append("<td class='field'><input type='text' name='").append(zipCodeFieldName).append("' value='").append(zipCode).append("' size='30'></td>");
    out.append("<td class='field'><input type='text' name='").append(cityFieldName).append("' value='").append(city).append("' size='30'></td>");
    out.append("</tr>");
    out.append("<tr><td class='label'>State</td><td class='label'>Country</td></tr>");
    out.append("<tr>");
    out.append("<td class='field'><input type='text' name='").append(stateFieldName).append("' value='").append(state).append("' size='30'></td>");
    out.append("<td class='field'><input type='text' name='").append(countryFieldName).append("' value='").append(country).append("' size='30'></td>");
    out.append("</tr>");
    out.append("<tr><td class='label'><table><tr><td style='text-align: left; width: 50%;'>Birthday</td><td style='width: 50%; text-align: right'>MM/DD/YYYY</td></tr></table></td><td class='label'>Gender</td></tr>");
    out.append("<tr>");
    out.append("<td class='field'><input type='text' name='").append(birthdayFieldName).append("' value='").append(birthday).append("' size='30'></td>");
    out.append("<td class='field'><select name='").append(genderFieldName).append("'>");
    out.append("<option value=''").append(">-- Please select --</option>");
    out.append("<option value='w'").append("w".equals(gender) ? "selected" : "").append(">Female</option>");
    out.append("<option value='m'").append("m".equals(gender) ? "selected" : "").append(">Male</option>");
    out.append("</select></td>");
    out.append("</tr>");
    out.append("<tr><td class='button' colspan='2'><input type='submit' name='").append(submitButtonName).append("' value='Submit'></td></tr>");
    out.append("<tr><td class='field' colspan='2'><input type='checkbox' name='").append(newsletterFieldName).append("' ").append(newsletter).append(">I would like to receive a newsletter</td></tr>");
    out.append("<tr><td class='field' colspan='2'><input type='checkbox' name='").append(agreedToTermsOfUseFieldName).append("' ").append(agreedToTermsOfUse).append(">I agree to the terms of use</td></tr>");
    out.append("</table>");
    out.append("<p>* must be filled out.</p>");
    out.append("</form>");
  }
}
