{
  HttpServletRequest request=CurrentRequest.getRequest();
  if (request == null) {
    return;
  }
  HttpSession session=request.getSession();
  if (session == null) {
    return;
  }
  String usernameFromSession=(String)session.getAttribute(WebNode.USERNAME_KEY);
  Boolean loggedIn=usernameFromSession != null;
  if (!loggedIn) {
    logger.log(Level.WARNING,"Not logged in");
    return;
  }
  Boolean sessionBlocked=(Boolean)session.getAttribute(WebNode.SESSION_BLOCKED);
  if (Boolean.TRUE.equals(sessionBlocked)) {
    logger.log(Level.WARNING,"Session blocked");
    return;
  }
  String categoryParameterName=currentNode.getCategoryParameterName() != null ? currentNode.getCategoryParameterName() : defaultCategoryParameterName;
  String categoryName=request.getParameter(categoryParameterName);
  String objectId=request.getParameter("id");
  if (StringUtils.isEmpty(categoryName)) {
    logger.log(Level.WARNING,"No category given");
    return;
  }
  if (StringUtils.isEmpty(objectId)) {
    logger.log(Level.WARNING,"No object id given");
    return;
  }
  String[] ids=StringUtils.split(objectId,",");
  for (  String id : ids) {
    User user=CurrentSession.getUser();
    AbstractNode addedObject=user.addToCategory(categoryName,id);
    if (addedObject != null) {
      out.append("<div class=\"okMsg\">").append(addedObject.getName()).append(" successfully added to ").append(categoryName).append("</div>");
    }
 else {
      out.append("<div class=\"errorMsg\">").append("Could not add to category ").append(categoryName).append("</div>");
    }
  }
}
