{
  String sourceJarName=app.getProtectionDomain().getCodeSource().getLocation().toString();
  if (!isTest && StringUtils.stripEnd(sourceJarName,System.getProperty("file.separator")).endsWith("classes")) {
    String jarFile=System.getProperty("jarFile");
    if (StringUtils.isEmpty(jarFile)) {
      throw new IllegalArgumentException(app.getName() + " was started in an environment where the classloader cannot determine the JAR file containing the main class.\n" + "Please specify the path to the JAR file in the parameter -DjarFile.\n"+ "Example: -DjarFile=${project.build.directory}/${project.artifactId}-${project.version}.jar");
    }
    sourceJarName=jarFile;
  }
  basePath=System.getProperty("home",basePath);
  if (basePath.isEmpty()) {
    basePath=System.getProperty("user.dir","/tmp");
  }
  File baseDir=new File(basePath);
  if (!baseDir.exists()) {
    baseDir.mkdirs();
  }
  configuredServices.add(ModuleService.class);
  configuredServices.add(NodeService.class);
  configuredServices.add(AgentService.class);
  configuredServices.add(CronService.class);
  configuredServices.add(LogService.class);
  File confFile=checkStructrConf(basePath,sourceJarName);
  Properties configuration=getConfiguration(confFile);
  checkPrerequisites(configuration);
  Server server=new Server(restPort);
  ContextHandlerCollection contexts=new ContextHandlerCollection();
  contexts.addHandler(new DefaultHandler());
  List<Connector> connectors=new LinkedList<Connector>();
  ServletContextHandler servletContext=new WebAppContext(server,basePath,contextPath);
  servletContext.setBaseResource(new ResourceCollection(Resource.newResource(basePath),JarResource.newJarResource(Resource.newResource(sourceJarName))));
  servletContext.setInitParameter("configfile.path",confFile.getAbsolutePath());
  if (enableGzipCompression) {
    FilterHolder gzipFilter=servletContext.addFilter(GzipFilter.class,"/*",EnumSet.of(DispatcherType.REQUEST,DispatcherType.FORWARD));
    gzipFilter.setInitParameter("mimeTypes","text/html,text/plain,text/css,text/javascript");
  }
  if (enableRewriteFilter) {
    FilterHolder rewriteFilter=servletContext.addFilter(UrlRewriteFilter.class,"/*",EnumSet.of(DispatcherType.REQUEST,DispatcherType.FORWARD));
    rewriteFilter.setInitParameter("confPath","/urlrewrite.xml");
  }
  contexts.addHandler(servletContext);
  if (logRequests) {
    String etcPath=basePath + "/etc";
    File etcDir=new File(etcPath);
    if (!etcDir.exists()) {
      etcDir.mkdir();
    }
    String logbackConfFilePath=basePath + "/etc/logback-access.xml";
    File logbackConfFile=new File(logbackConfFilePath);
    if (!logbackConfFile.exists()) {
      List<String> config=new LinkedList<String>();
      config.add("<configuration>");
      config.add("  <appender name=\"FILE\" class=\"ch.qos.logback.core.rolling.RollingFileAppender\">");
      config.add("    <rollingPolicy class=\"ch.qos.logback.core.rolling.TimeBasedRollingPolicy\">");
      config.add("      <fileNamePattern>logs/" + logPrefix + "-%d{yyyy_MM_dd}.request.log.zip</fileNamePattern>");
      config.add("    </rollingPolicy>");
      config.add("    <encoder>");
      config.add("      <charset>UTF-8</charset>");
      config.add("      <pattern>%h %l %u %t \"%r\" %s %b %n%fullRequest%n%n%fullResponse</pattern>");
      config.add("    </encoder>");
      config.add("  </appender>");
      config.add("  <appender-ref ref=\"FILE\" />");
      config.add("</configuration>");
      logbackConfFile.createNewFile();
      FileUtils.writeLines(logbackConfFile,"UTF-8",config);
    }
    FilterHolder loggingFilter=servletContext.addFilter(TeeFilter.class,"/*",EnumSet.of(DispatcherType.REQUEST,DispatcherType.FORWARD));
    loggingFilter.setInitParameter("includes","");
    RequestLogHandler requestLogHandler=new RequestLogHandler();
    String logPath=basePath + "/logs";
    File logDir=new File(logPath);
    if (!logDir.exists()) {
      logDir.mkdir();
    }
    RequestLogImpl requestLog=new RequestLogImpl();
    requestLogHandler.setRequestLog(requestLog);
    HandlerCollection handlers=new HandlerCollection();
    handlers.setHandlers(new Handler[]{contexts,new DefaultHandler(),requestLogHandler});
    server.setHandler(handlers);
  }
 else {
    server.setHandler(contexts);
  }
  if (resourceHandler != null) {
    ContextHandler staticResourceHandler=new ContextHandler();
    staticResourceHandler.setContextPath(staticResourceContextPath);
    staticResourceHandler.setHandler(resourceHandler);
    contexts.addHandler(staticResourceHandler);
  }
  ResourceProvider resourceProviderInstance=resourceProvider.newInstance();
  JsonRestServlet structrRestServlet=new JsonRestServlet(resourceProviderInstance,defaultPropertyView,AbstractNode.uuid);
  ServletHolder structrRestServletHolder=new ServletHolder(structrRestServlet);
  servletParams.put("PropertyFormat","FlatNameValue");
  servletParams.put("Authenticator",authenticator.getName());
  structrRestServletHolder.setInitParameters(servletParams);
  structrRestServletHolder.setInitOrder(0);
  servlets.put(restUrl + "/*",structrRestServletHolder);
  int position=1;
  for (  Entry<String,ServletHolder> servlet : servlets.entrySet()) {
    String path=servlet.getKey();
    ServletHolder servletHolder=servlet.getValue();
    servletHolder.setInitOrder(position++);
    logger.log(Level.INFO,"Adding servlet {0} for {1}",new Object[]{servletHolder,path});
    servletContext.addServlet(servletHolder,path);
  }
  servletContext.addEventListener(new ApplicationContextListener());
  contexts.addHandler(servletContext);
  if (enableHttps) {
    if (httpsPort > -1 && keyStorePath != null && !keyStorePath.isEmpty() && keyStorePassword != null) {
      SslSelectChannelConnector httpsConnector=null;
      SslContextFactory factory=new SslContextFactory(keyStorePath);
      factory.setKeyStorePassword(keyStorePassword);
      httpsConnector=new SslSelectChannelConnector(factory);
      httpsConnector.setHost(host);
      httpsConnector.setPort(httpsPort);
      httpsConnector.setMaxIdleTime(maxIdleTime);
      httpsConnector.setRequestHeaderSize(requestHeaderSize);
      connectors.add(httpsConnector);
    }
 else {
      logger.log(Level.WARNING,"Unable to configure SSL, please make sure that application.https.port, application.keystore.path and application.keystore.password are set correctly in structr.conf.");
    }
  }
  if (host != null && !host.isEmpty() && restPort > -1) {
    SelectChannelConnector httpConnector=new SelectChannelConnector();
    httpConnector.setHost(host);
    httpConnector.setPort(restPort);
    httpConnector.setMaxIdleTime(maxIdleTime);
    httpConnector.setRequestHeaderSize(requestHeaderSize);
    connectors.add(httpConnector);
  }
 else {
    logger.log(Level.WARNING,"Unable to configure REST port, please make sure that application.host, application.rest.port and application.rest.path are set correctly in structr.conf.");
  }
  if (!connectors.isEmpty()) {
    server.setConnectors(connectors.toArray(new Connector[0]));
  }
 else {
    logger.log(Level.SEVERE,"No connectors configured, aborting.");
    System.exit(0);
  }
  server.setGracefulShutdown(1000);
  server.setStopAtShutdown(true);
  if (!quiet) {
    System.out.println();
    System.out.println("Starting " + applicationName + " (host="+ host+ ":"+ restPort+ ", maxIdleTime="+ maxIdleTime+ ", requestHeaderSize="+ requestHeaderSize+ ")");
    System.out.println("Base path " + basePath);
    System.out.println();
    System.out.println(applicationName + " started:        http://" + host+ ":"+ restPort+ restUrl);
    System.out.println();
  }
  server.start();
  removeDir(basePath,"jsp");
  if (!callbacks.isEmpty()) {
    for (    Callback callback : callbacks) {
      callback.execute();
    }
  }
  if (waitForExit) {
    server.join();
    if (!quiet) {
      System.out.println();
      System.out.println(applicationName + " stopped.");
      System.out.println();
    }
  }
  return server;
}
