{
  final List<GraphObject> templates=getComponents(SecurityContext.getSuperUserInstance(),getSearchAttributes(rawType));
  final Command createNodeCommand=Services.command(securityContext,CreateNodeCommand.class);
  final Map<String,Object> templateProperties=new LinkedHashMap<String,Object>();
  final String componentId=UUID.randomUUID().toString().replaceAll("[\\-]+","");
  final Component template=(Component)templates.get(templates.size() - 1);
  templateProperties.put(AbstractNode.Key.type.name(),Component.class.getSimpleName());
  templateProperties.put(Component.UiKey.kind.name(),template.getStringProperty(Component.UiKey.kind.name()));
  templateProperties.put(AbstractNode.Key.uuid.name(),componentId);
  templateProperties.put(AbstractNode.Key.visibleToPublicUsers.name(),template.getBooleanProperty(AbstractNode.Key.visibleToPublicUsers));
  templateProperties.put(AbstractNode.Key.visibleToAuthenticatedUsers.name(),template.getBooleanProperty(AbstractNode.Key.visibleToAuthenticatedUsers));
  String parentComponentId=template.getComponentId();
  propertySet.remove("pageId");
  if (surroundingComponentId != null) {
    parentComponentId=surroundingComponentId;
  }
  final String finalParentComponentId=parentComponentId;
  Component newComponent=(Component)Services.command(securityContext,TransactionCommand.class).execute(new StructrTransaction(){
    @Override public Object execute() throws FrameworkException {
      Component comp=(Component)createNodeCommand.execute(templateProperties);
      RelationshipHelper.copyRelationships(SecurityContext.getSuperUserInstance(),template,comp,RelType.CONTAINS,finalParentComponentId,true);
      Map<String,Object> contentTemplateProperties=new LinkedHashMap<String,Object>();
      for (      AbstractNode node : template.getContentNodes().values()) {
        if (node instanceof Content) {
          Content contentTemplate=(Content)node;
          String dataKey=contentTemplate.getStringProperty("data-key");
          contentTemplateProperties.clear();
          contentTemplateProperties.put(AbstractNode.Key.type.name(),Content.class.getSimpleName());
          contentTemplateProperties.put("data-key",dataKey);
          contentTemplateProperties.put(Content.UiKey.content.name(),propertySet.get(dataKey));
          contentTemplateProperties.put(AbstractNode.Key.visibleToPublicUsers.name(),propertySet.get(AbstractNode.Key.visibleToAuthenticatedUsers.name()));
          contentTemplateProperties.put(AbstractNode.Key.visibleToAuthenticatedUsers.name(),propertySet.get(AbstractNode.Key.visibleToAuthenticatedUsers.name()));
          contentTemplateProperties.put(Content.UiKey.validationExpression.name(),propertySet.get(Content.UiKey.validationExpression.name()));
          contentTemplateProperties.put(Content.UiKey.validationErrorMessage.name(),propertySet.get(Content.UiKey.validationErrorMessage.name()));
          Content newContent=(Content)createNodeCommand.execute(contentTemplateProperties);
          propertySet.remove(dataKey);
          RelationshipHelper.copyRelationships(SecurityContext.getSuperUserInstance(),contentTemplate,newContent,RelType.CONTAINS,componentId,false);
        }
      }
      return comp;
    }
  }
);
  if (newComponent != null) {
    propertySet.remove(AbstractNode.Key.createdDate.name());
    propertySet.remove(AbstractNode.Key.lastModifiedDate.name());
    for (    String key : propertySet.keySet()) {
      newComponent.setProperty(key,propertySet.get(key));
    }
  }
  return newComponent;
}
