{
  final SecurityContext securityContext=getWebSocket().getSecurityContext();
  String nodeId=webSocketData.getId();
  final AbstractNode nodeToWrap=getNode(nodeId);
  final Map<String,Object> nodeData=webSocketData.getNodeData();
  final Map<String,Object> relData=webSocketData.getRelData();
  final String pageId=(String)relData.get("pageId");
  final String parentId=(String)nodeData.get("parentId");
  final AbstractNode parentNode=getNode(parentId);
  final Long position=Long.parseLong((String)relData.get(pageId));
  if (nodeToWrap != null) {
    StructrTransaction transaction=new StructrTransaction(){
      @Override public Object execute() throws FrameworkException {
        Component newComponent=(Component)Services.command(securityContext,CreateNodeCommand.class).execute(nodeData);
        String componentId=newComponent.getStringProperty(AbstractNode.uuid);
        RelationshipHelper.moveIncomingRelationships(securityContext,nodeToWrap,newComponent,RelType.CONTAINS,pageId,newComponent.getStringProperty(AbstractNode.uuid),false);
        if ((parentNode != null) && (newComponent != null)) {
          RelationClass rel=EntityContext.getRelationClass(parentNode.getClass(),newComponent.getClass());
          if (rel != null) {
            Map<String,Object> relProps=new LinkedHashMap<String,Object>();
            relProps.put(pageId,0);
            relProps.put("componentId",componentId);
            try {
              rel.createRelationship(securityContext,newComponent,nodeToWrap,relProps);
            }
 catch (            Throwable t) {
              getWebSocket().send(MessageBuilder.status().code(400).message(t.getMessage()).build(),true);
            }
            tagOutgoingRelsWithComponentId(newComponent,newComponent,componentId);
          }
        }
 else {
          getWebSocket().send(MessageBuilder.status().code(404).build(),true);
        }
        return null;
      }
    }
;
    try {
      Services.command(securityContext,TransactionCommand.class).execute(transaction);
    }
 catch (    FrameworkException fex) {
      logger.log(Level.WARNING,"Could not create node.",fex);
      getWebSocket().send(MessageBuilder.status().code(fex.getStatus()).message(fex.getMessage()).build(),true);
    }
  }
 else {
    logger.log(Level.WARNING,"Node with uuid {0} not found.",webSocketData.getId());
    getWebSocket().send(MessageBuilder.status().code(404).build(),true);
  }
}
