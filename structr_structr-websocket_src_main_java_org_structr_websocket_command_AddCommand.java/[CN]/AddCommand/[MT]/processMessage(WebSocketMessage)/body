{
  final SecurityContext securityContext=getWebSocket().getSecurityContext();
  final Map<String,Object> nodeData=webSocketData.getNodeData();
  String containedNodeId=(String)nodeData.get("id");
  final Map<String,Object> relData=webSocketData.getRelData();
  String containingNodeId=webSocketData.getId();
  if (containingNodeId != null) {
    AbstractNode containedNode=null;
    AbstractNode containingNode=getNode(containingNodeId);
    if (containedNodeId != null) {
      containedNode=getNode(containedNodeId);
    }
 else {
      StructrTransaction transaction=new StructrTransaction(){
        @Override public Object execute() throws FrameworkException {
          return Services.command(securityContext,CreateNodeCommand.class).execute(nodeData);
        }
      }
;
      try {
        containedNode=(AbstractNode)Services.command(securityContext,TransactionCommand.class).execute(transaction);
      }
 catch (      FrameworkException fex) {
        logger.log(Level.WARNING,"Could not create node.",fex);
        getWebSocket().send(MessageBuilder.status().code(fex.getStatus()).message(fex.getMessage()).build(),true);
      }
    }
    if ((containedNode != null) && (containingNode != null)) {
      String originalResourceId=(String)nodeData.get("sourceResourceId");
      String newResourceId=(String)nodeData.get("targetResourceId");
      RelationClass rel=EntityContext.getRelationClass(containingNode.getClass(),containedNode.getClass());
      if (rel != null) {
        try {
          rel.createRelationship(securityContext,containingNode,containedNode,relData);
          if ((originalResourceId != null) && (newResourceId != null) && !originalResourceId.equals(newResourceId)) {
            tagOutgoingRelsWithResourceId(containedNode,containedNode,originalResourceId,newResourceId);
          }
        }
 catch (        Throwable t) {
          getWebSocket().send(MessageBuilder.status().code(400).message(t.getMessage()).build(),true);
        }
      }
    }
 else {
      getWebSocket().send(MessageBuilder.status().code(404).build(),true);
    }
  }
 else {
    getWebSocket().send(MessageBuilder.status().code(400).message("Add needs id and data.id!").build(),true);
  }
}
