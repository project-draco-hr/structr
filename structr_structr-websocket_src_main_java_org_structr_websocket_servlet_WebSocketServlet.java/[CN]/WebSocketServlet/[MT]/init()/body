{
  config=this.getServletConfig();
  final String idPropertyName=this.getInitParameter(SERVLET_PARAMETER_ID_PROPERTY);
  if (idPropertyName != null) {
    logger.log(Level.INFO,"Setting id property to {0}",idPropertyName);
  }
  final Gson gson=new GsonBuilder().setPrettyPrinting().registerTypeAdapter(WebSocketMessage.class,new WebSocketDataGSONAdapter(idPropertyName)).create();
  syncController=new SynchronizationController(gson);
  EntityContext.registerTransactionListener(syncController);
  factory=new WebSocketFactory(new Acceptor(){
    @Override public WebSocket doWebSocketConnect(    final HttpServletRequest request,    final String protocol){
      if (STRUCTR_PROTOCOL.equals(protocol)) {
        return new StructrWebSocket(syncController,config,request,gson,idPropertyName);
      }
 else {
        logger.log(Level.INFO,"Protocol {0} not accepted",protocol);
      }
      return null;
    }
    @Override public boolean checkOrigin(    final HttpServletRequest request,    final String origin){
      return true;
    }
  }
);
}
